<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 曼谷聖誕跨年</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-bg': '#F9F8F4',
                        'jp-card': '#FFFFFF',
                        'jp-text': '#4A4A4A',
                        'jp-accent': '#C6A568',
                        'jp-blue': '#6B8EAD',
                        'jp-green': '#8DA399',
                        'jp-red': '#D67D7D',
                    },
                    fontFamily: {
                        sans: ['"Zen Kaku Gothic New"', '"Noto Sans TC"', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px rgba(0, 0, 0, 0.03)',
                        'float': '0 10px 30px rgba(0, 0, 0, 0.08)',
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #F0F0F0;
            font-family: 'Zen Kaku Gothic New', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .app-container {
            background-color: #F9F8F4;
            max-width: 430px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding-bottom: 100px;
            overflow-x: hidden;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .timeline-item { position: relative; padding-left: 24px; padding-bottom: 24px; border-left: 2px solid #E5E7EB; }
        .timeline-item:last-child { border-left: 2px solid transparent; }
        .timeline-dot { position: absolute; left: -7px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: #C6A568; border: 2px solid #F9F8F4; }
        .timeline-time { font-size: 11px; font-weight: bold; color: #6B8EAD; margin-bottom: 4px; display: block; }

        .account-type-btn.active { border: 1px solid #C6A568; background-color: #FFFCF5; color: #C6A568; }
        .split-btn.active { background-color: #4A4A4A; color: white; font-weight: bold; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100;
            display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; }
    </style>
</head>
<body>

<div class="app-container">
    
    <header class="sticky top-0 z-50 bg-[#F9F8F4]/95 backdrop-blur-sm px-5 py-4 flex justify-between items-end border-b border-gray-100">
        <div>
            <p class="text-xs text-gray-400 tracking-widest mb-1">DEC 23 - DEC 28</p>
            <h1 class="text-xl font-bold text-jp-text tracking-wide leading-tight">2025 曼谷聖誕跨年<br><span class="text-jp-accent text-lg">- 泰廢了 -</span></h1>
        </div>
        <div class="flex gap-3">
             <div class="text-center" id="weather-box">
                <span class="block text-xs text-gray-400">曼谷</span>
                <span class="text-sm font-medium" id="temp-display">Loading...</span>
             </div>
        </div>
    </header>

    <div id="tab-home" class="section active px-5 py-4">
        
        <div class="bg-white rounded-2xl p-4 shadow-soft mb-6">
            <h3 class="text-sm font-bold text-jp-text mb-2">求生泰語翻譯</h3>
            <div class="flex gap-2">
                <input type="text" id="thai-input" placeholder="輸入中文 (例: 不要香菜)" class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-jp-accent">
                <button onclick="translateThai()" class="w-10 h-10 bg-jp-green/10 rounded-lg flex items-center justify-center text-jp-green active:scale-95 transition">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
        </div>

        <h3 class="text-sm font-bold text-gray-400 mb-3 ml-1">QUICK ACCESS</h3>
        <div class="grid grid-cols-2 gap-3 mb-20">
            <button onclick="switchTab('tab-itinerary')" class="bg-white p-4 rounded-xl shadow-soft text-left flex flex-col justify-between h-24 relative overflow-hidden group active:scale-95 transition">
                <div class="absolute top-0 right-0 w-12 h-12 bg-jp-blue/10 rounded-full -mr-4 -mt-4"></div>
                <i class="fas fa-map-marked-alt text-jp-blue text-xl relative z-10"></i>
                <div>
                    <span class="text-sm font-bold block text-jp-text">行程規劃</span>
                    <span class="text-xs text-gray-400 font-sans" id="current-date-display">Dec 23, 2025</span>
                </div>
            </button>

            <button onclick="switchTab('tab-account')" class="bg-white p-4 rounded-xl shadow-soft text-left flex flex-col justify-between h-24 border border-jp-accent/20 active:scale-95 transition">
                <div class="flex justify-between">
                    <i class="fas fa-calculator text-jp-red text-xl"></i>
                    <span class="text-[10px] bg-gray-100 px-1 rounded text-gray-500" id="home-balance">公費: $0</span>
                </div>
                <div>
                    <span class="text-sm font-bold block text-jp-text">智慧記帳</span>
                    <span class="text-xs text-gray-400">點擊記帳</span>
                </div>
            </button>

             <button onclick="switchTab('tab-checklist')" class="bg-white p-4 rounded-xl shadow-soft text-left flex flex-col justify-between h-24 active:scale-95 transition">
                <i class="fas fa-tasks text-jp-accent text-xl"></i>
                <div>
                    <span class="text-sm font-bold block text-jp-text">行李清單</span>
                    <span class="text-xs text-gray-400" id="home-check-progress">完成度 0%</span>
                </div>
            </button>
        </div>
    </div>

    <div id="tab-itinerary" class="section px-4 py-4 pb-24">
        
        <div class="flex gap-2 mb-6 overflow-x-auto hide-scrollbar">
            <label class="bg-white px-4 py-2 rounded-full border border-gray-100 shadow-sm flex items-center gap-2 whitespace-nowrap">
                <input type="checkbox" id="check-esim" class="accent-jp-green" onchange="toggleGlobalCheck('esim')">
                <span class="text-xs font-bold text-jp-text">eSIM</span>
            </label>
            <label class="bg-white px-4 py-2 rounded-full border border-gray-100 shadow-sm flex items-center gap-2 whitespace-nowrap">
                <input type="checkbox" id="check-insurance" class="accent-jp-green" onchange="toggleGlobalCheck('insurance')">
                <span class="text-xs font-bold text-jp-text">旅遊保險</span>
            </label>
        </div>

        <h3 class="text-sm font-bold text-gray-400 mb-3 uppercase tracking-wider">Accommodation</h3>
        <div class="space-y-3 mb-8">
            <div class="bg-white p-4 rounded-xl shadow-soft border-l-4 border-jp-accent">
                <div class="flex justify-between items-start">
                    <div>
                        <span class="text-[10px] bg-jp-bg text-jp-accent px-2 py-1 rounded font-bold">12/23 - 12/25</span>
                        <h4 class="font-bold text-jp-text mt-1">B2 唐人街耀華力尊尚飯店</h4>
                        <p class="text-xs text-gray-400 mt-1">唐人街附近</p>
                    </div>
                    <a href="https://maps.google.com/?q=B2+China+Town+Yaowarat+Premier+Hotel" target="_blank" class="text-jp-blue"><i class="fas fa-map-marker-alt"></i></a>
                </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-soft border-l-4 border-jp-blue">
                <div class="flex justify-between items-start">
                    <div>
                        <span class="text-[10px] bg-jp-bg text-jp-blue px-2 py-1 rounded font-bold">12/25 - 12/27</span>
                        <h4 class="font-bold text-jp-text mt-1">曼谷茉莉花59號飯店</h4>
                        <p class="text-xs text-gray-400 mt-1">通羅BTS附近 (Jasmine 59)</p>
                    </div>
                    <a href="https://maps.google.com/?q=Jasmine+59+Hotel" target="_blank" class="text-jp-blue"><i class="fas fa-map-marker-alt"></i></a>
                </div>
            </div>
        </div>

        <h3 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">Itinerary</h3>
        
        <div class="mb-6">
            <div class="sticky top-16 bg-[#F9F8F4] z-10 py-2 mb-2 border-b border-gray-200">
                <h4 class="font-bold text-lg text-jp-text">Day 1 <span class="text-sm font-normal text-gray-500 ml-2">12/23 (二)</span></h4>
            </div>
            <div class="pl-2">
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <span class="timeline-time">18:00 - 21:30</span>
                    <p class="text-sm text-jp-text font-medium"><i class="fas fa-plane text-jp-blue mr-1"></i> 高雄 -> 廊曼 (FD235)</p>
                </div>
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <span class="timeline-time">21:30 - 22:30</span>
                    <p class="text-sm text-jp-text font-medium">包車接機 -> 飯店Check-in</p>
                </div>
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <span class="timeline-time">Late Night</span>
                    <p class="text-sm text-jp-text font-medium">唐人街宵夜</p>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <div class="sticky top-16 bg-[#F9F8F4] z-10 py-2 mb-2 border-b border-gray-200">
                <h4 class="font-bold text-lg text-jp-text">Day 2 <span class="text-sm font-normal text-gray-500 ml-2">12/24 (三)</span></h4>
            </div>
            <div class="pl-2">
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <span class="timeline-time">Daytime</span>
                    <p class="text-sm text-jp-text font-medium mb-1">① 石龍軍路 / 臥佛寺 / 鄭王廟</p>
                    <p class="text-sm text-jp-text font-medium">④ 王朗市場</p>
                </div>
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <span class="timeline-time">Evening</span>
                    <p class="text-sm text-jp-text font-medium">River City 郵輪晚餐</p>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <div class="sticky top-16 bg-[#F9F8F4] z-10 py-2 mb-2 border-b border-gray-200">
                <h4 class="font-bold text-lg text-jp-text">Day 3 <span class="text-sm font-normal text-gray-500 ml-2">12/25 (四)</span></h4>
            </div>
            <div class="pl-2">
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <span class="timeline-time">Morning</span>
                    <p class="text-sm text-jp-text font-medium">早餐: 益生甫記 / 安樂園 & 嵩越路</p>
                </div>
                 <div class="timeline-item">
                    <div class="timeline-dot" style="background: #6B8EAD"></div>
                    <span class="timeline-time text-jp-blue">Check-out / Move</span>
                    <p class="text-sm text-jp-text font-medium">移動至 Jasmine 59 Hotel (通羅)</p>
                </div>
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <span class="timeline-time">Afternoon/Night</span>
                    <p class="text-sm text-jp-text font-medium mb-1">石龍軍路 / 唐人街 / 考山路</p>
                    <p class="text-sm text-jp-text font-medium">百貨公司 (Iconsiam/Central)</p>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <div class="sticky top-16 bg-[#F9F8F4] z-10 py-2 mb-2 border-b border-gray-200">
                <h4 class="font-bold text-lg text-jp-text">Day 4 <span class="text-sm font-normal text-gray-500 ml-2">12/26 (五)</span></h4>
            </div>
            <div class="pl-2">
                <div class="timeline-item">
                    <div class="timeline-dot bg-red-500 border-red-500"></div>
                    <span class="timeline-time text-red-500">08:00 AM</span>
                    <p class="text-sm text-jp-text font-bold">包車出發 (飯店大廳)</p>
                </div>
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <span class="timeline-time">Day Trip</span>
                    <p class="text-sm text-jp-text font-medium">美功鐵道市場 / 丹嫩莎水上市場 / 樹中廟</p>
                </div>
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <span class="timeline-time">15:00 - 16:00</span>
                    <p class="text-sm text-jp-text font-medium">回到曼谷市區</p>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-account" class="section px-4 py-4 pb-24">
        
        <a href="https://docs.google.com/spreadsheets/create" target="_blank" class="block bg-green-50 border border-green-200 rounded-xl p-3 mb-6 flex items-center justify-between shadow-sm active:scale-95 transition">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white">
                    <i class="fas fa-file-excel"></i>
                </div>
                <div>
                    <h4 class="text-sm font-bold text-jp-text">打開共用 Google Sheet</h4>
                    <p class="text-[10px] text-gray-500">如果需要多人即時同步，建議用這個</p>
                </div>
            </div>
            <i class="fas fa-external-link-alt text-gray-400 text-sm"></i>
        </a>

        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-jp-text">公費記帳 (本機版)</h2>
            <button onclick="clearTransactions()" class="text-xs text-gray-400 underline">清空紀錄</button>
        </div>
        
        <div class="bg-jp-card rounded-2xl shadow-soft p-5 border border-gray-100 mb-6">
            <div class="mb-5">
                <p class="text-xs text-gray-400 mb-2">分類</p>
                <div class="flex justify-between gap-2 overflow-x-auto hide-scrollbar pb-2" id="category-container"></div>
            </div>

            <div class="mb-5">
                <div class="flex gap-3 mb-2">
                    <div class="w-1/3 bg-gray-50 rounded-xl flex p-1 border border-gray-100">
                        <button onclick="setCurrency('TWD')" id="btn-twd" class="w-1/2 rounded-lg text-xs font-bold text-gray-400 transition">TWD</button>
                        <button onclick="setCurrency('THB')" id="btn-thb" class="w-1/2 rounded-lg text-xs font-bold text-jp-text bg-white shadow-sm transition">THB</button>
                    </div>
                    <input type="number" id="amount-input" placeholder="0" class="w-2/3 text-right text-3xl font-bold text-jp-text bg-transparent border-b border-gray-200 focus:outline-none focus:border-jp-accent p-1">
                </div>
                <div class="flex items-center justify-end gap-2 px-1">
                    <span class="text-xs text-gray-400">公費包餘額:</span>
                    <span class="text-sm font-bold text-jp-text" id="public-fund-display">฿ 0</span>
                </div>
            </div>

            <div class="mb-5">
                <p class="text-xs text-gray-400 mb-2">付款人</p>
                <div class="flex flex-wrap gap-2" id="payer-container"></div>
            </div>

            <div class="mb-5">
                <p class="text-xs text-gray-400 mb-2">模式</p>
                <div class="bg-gray-50 rounded-xl p-1 grid grid-cols-2 gap-1">
                    <button onclick="setSplit('shared')" class="split-btn active py-2 rounded-lg text-xs transition" id="split-shared">共同分攤</button>
                    <button onclick="setSplit('deposit')" class="split-btn py-2 rounded-lg text-xs transition text-gray-400" id="split-deposit">公費入金</button>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                 <div class="flex-1 relative">
                    <input type="text" id="note-input" placeholder="備註 (例如: 7-11)" class="w-full h-12 bg-gray-50 rounded-full px-4 text-sm border border-gray-200 focus:outline-none focus:border-jp-accent">
                 </div>
            </div>

            <button onclick="submitTransaction()" class="w-full mt-4 bg-jp-text text-white rounded-xl font-bold py-3 shadow-lg hover:opacity-90 active:scale-95 transition">
                新增紀錄
            </button>
        </div>

        <div id="transaction-history" class="space-y-2">
            </div>
    </div>
    
    <div id="tab-checklist" class="section px-5 py-4 pb-24">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">行李清單</h2>
            <button onclick="addChecklistItem()" class="w-8 h-8 rounded-full bg-jp-accent text-white flex items-center justify-center shadow-md active:scale-90">
                <i class="fas fa-plus text-xs"></i>
            </button>
        </div>
        
        <div id="checklist-container"></div>
    </div>

    <div id="tab-tools" class="section px-5 py-4">
        <h2 class="text-xl font-bold mb-6">資料同步 & 設定</h2>
        
        <div class="bg-white rounded-2xl shadow-soft p-5 mb-6">
            <h3 class="font-bold text-jp-text mb-3">資料同步 (免伺服器)</h3>
            <p class="text-xs text-gray-400 mb-4">因為沒有雲端，請用這個方法傳送資料給朋友：</p>
            
            <div class="flex gap-3 mb-4">
                <button onclick="exportData()" class="flex-1 bg-jp-blue text-white py-2 rounded-lg text-sm shadow hover:opacity-90">
                    <i class="fas fa-upload mr-1"></i> 1. 複製資料
                </button>
                <button onclick="openImportModal()" class="flex-1 bg-gray-600 text-white py-2 rounded-lg text-sm shadow hover:opacity-90">
                    <i class="fas fa-download mr-1"></i> 2. 貼上資料
                </button>
            </div>
            <p class="text-[10px] text-jp-red bg-red-50 p-2 rounded">
                注意：匯入資料會覆蓋掉你手機上目前的紀錄，請小心使用。
            </p>
        </div>

        <div class="bg-white rounded-2xl shadow-soft p-5">
             <h3 class="font-bold text-jp-text mb-3">人員設定</h3>
             <p class="text-xs text-gray-400 mb-2">目前的旅伴：</p>
             <div id="settings-users" class="flex flex-wrap gap-2 mb-3"></div>
             <button onclick="editUsers()" class="text-xs text-jp-blue underline">新增人員</button>
        </div>
        
        <div class="mt-8 text-center">
             <button onclick="hardReset()" class="text-xs text-red-400 underline p-2">重置所有 App 資料</button>
        </div>
    </div>

    <nav class="fixed bottom-6 left-5 right-5 h-16 glass-nav rounded-2xl flex justify-around items-center shadow-float z-50">
        <button onclick="switchTab('tab-home')" class="nav-btn active flex flex-col items-center gap-1 text-jp-accent" data-target="tab-home">
            <i class="fas fa-home text-lg"></i>
            <span class="text-[10px]">首頁</span>
        </button>
        <button onclick="switchTab('tab-itinerary')" class="nav-btn flex flex-col items-center gap-1 text-gray-300" data-target="tab-itinerary">
            <i class="fas fa-map-marked-alt text-lg"></i>
            <span class="text-[10px]">行程</span>
        </button>
        <div class="relative -top-6">
            <button onclick="switchTab('tab-account')" class="w-14 h-14 bg-jp-text rounded-full shadow-lg flex items-center justify-center text-white text-xl transform hover:scale-105 transition active:scale-95">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        <button onclick="switchTab('tab-checklist')" class="nav-btn flex flex-col items-center gap-1 text-gray-300" data-target="tab-checklist">
            <i class="fas fa-check-circle text-lg"></i>
            <span class="text-[10px]">清單</span>
        </button>
        <button onclick="switchTab('tab-tools')" class="nav-btn flex flex-col items-center gap-1 text-gray-300" data-target="tab-tools">
            <i class="fas fa-cog text-lg"></i>
            <span class="text-[10px]">我的</span>
        </button>
    </nav>

    <div id="import-modal" class="modal-overlay">
        <div class="bg-white w-4/5 rounded-2xl p-5 shadow-2xl">
            <h3 class="font-bold text-lg mb-2">貼上資料代碼</h3>
            <textarea id="import-area" class="w-full h-32 bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs mb-4" placeholder="請在此貼上朋友傳來的代碼..."></textarea>
            <div class="flex gap-2">
                <button onclick="closeModal('import-modal')" class="flex-1 py-2 rounded-lg border border-gray-200 text-sm">取消</button>
                <button onclick="confirmImport()" class="flex-1 py-2 rounded-lg bg-jp-text text-white text-sm">確定匯入</button>
            </div>
        </div>
    </div>

</div>

<script>
    // --- STATE MANAGEMENT ---
    // Default State if nothing in LocalStorage
    const defaultState = {
        globalChecks: { esim: false, insurance: false },
        currency: 'THB',
        currentSplit: 'shared',
        fundBalance: 0, 
        users: ['小朱', '簡哥', '阿美'], 
        transactions: [], // { id, amount, currency, payer, type, note, date }
        checklist: [
            {
                title: '證件文件',
                items: [
                    { name: '護照', checked: false },
                    { name: '電子機票', checked: false },
                    { name: '飯店憑證', checked: false }
                ]
            },
            {
                title: '電子用品',
                items: [
                    { name: '充電線/行動電源', checked: false },
                    { name: '網卡/針', checked: false }
                ]
            }
        ]
    };

    let appState = JSON.parse(JSON.stringify(defaultState));

    // --- LOCAL STORAGE FUNCTIONS ---
    function saveState() {
        localStorage.setItem('bkk_trip_2025_v2', JSON.stringify(appState));
        updateFundDisplay();
        renderTransactionHistory();
    }

    function loadState() {
        const saved = localStorage.getItem('bkk_trip_2025_v2');
        if (saved) {
            try {
                appState = JSON.parse(saved);
                // Merge if new fields added in update (simple check)
                if(!appState.transactions) appState.transactions = [];
            } catch(e) {
                console.error("Data corrupted, resetting");
                saveState();
            }
        }
        // Apply State to UI
        document.getElementById('check-esim').checked = appState.globalChecks.esim || false;
        document.getElementById('check-insurance').checked = appState.globalChecks.insurance || false;
        
        renderCategories();
        renderPayers();
        updateFundDisplay();
        renderChecklist();
        renderSettingsUsers();
        renderTransactionHistory();
        setCurrency(appState.currency);
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        updateDate();
        fetchWeather();
        loadState(); // LOAD DATA ON START
    });

    // --- EXPORT / IMPORT LOGIC ---
    function exportData() {
        const dataStr = JSON.stringify(appState);
        navigator.clipboard.writeText(dataStr).then(() => {
            alert("已複製資料！\n請貼上到 LINE 傳給朋友");
        }).catch(err => {
            alert("複製失敗，請手動複製 console log");
            console.log(dataStr);
        });
    }

    function openImportModal() {
        document.getElementById('import-modal').classList.add('open');
        document.getElementById('import-area').value = "";
    }

    function confirmImport() {
        const str = document.getElementById('import-area').value;
        if(!str) return;
        try {
            const data = JSON.parse(str);
            if(confirm("確定要匯入嗎？這會覆蓋現在的紀錄")) {
                appState = data;
                saveState();
                loadState(); // Re-render everything
                closeModal('import-modal');
                alert("匯入成功！");
            }
        } catch(e) {
            alert("資料格式錯誤，請確認代碼完整");
        }
    }

    function hardReset() {
        if(confirm("確定要重置所有資料嗎？無法復原")) {
            appState = JSON.parse(JSON.stringify(defaultState));
            saveState();
            loadState();
            alert("已重置");
        }
    }

    // --- HOME PAGE LOGIC ---
    function updateDate() {
        const today = new Date();
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        document.getElementById('current-date-display').innerText = today.toLocaleDateString('en-US', options);
    }

    async function fetchWeather() {
        try {
            const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=13.7563&longitude=100.5018&current_weather=true');
            const data = await res.json();
            const temp = Math.round(data.current_weather.temperature);
            document.getElementById('temp-display').innerHTML = `${temp}°C <i class="fas fa-sun text-jp-accent"></i>`;
        } catch (e) {
            document.getElementById('temp-display').innerText = "29°C";
        }
    }

    function translateThai() {
        const text = document.getElementById('thai-input').value;
        if (!text) return alert("請輸入文字");
        const url = `https://translate.google.com/?sl=zh-TW&tl=th&text=${encodeURIComponent(text)}&op=translate`;
        window.open(url, '_blank');
    }

    function toggleGlobalCheck(type) {
        appState.globalChecks[type] = document.getElementById(`check-${type}`).checked;
        saveState();
    }

    // --- NAVIGATION ---
    function switchTab(tabId) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('text-jp-accent');
            btn.classList.add('text-gray-300');
            if(btn.dataset.target === tabId) {
                btn.classList.remove('text-gray-300');
                btn.classList.add('text-jp-accent');
            }
        });
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('open');
    }

    // --- ACCOUNTING LOGIC ---
    function setCurrency(curr) {
        appState.currency = curr;
        saveState();
        document.getElementById('btn-twd').className = curr === 'TWD' 
            ? "w-1/2 rounded-lg text-xs font-bold text-jp-text bg-white shadow-sm transition" 
            : "w-1/2 rounded-lg text-xs font-bold text-gray-400 transition";
        document.getElementById('btn-thb').className = curr === 'THB' 
            ? "w-1/2 rounded-lg text-xs font-bold text-jp-text bg-white shadow-sm transition" 
            : "w-1/2 rounded-lg text-xs font-bold text-gray-400 transition";
    }

    function renderPayers() {
        const container = document.getElementById('payer-container');
        let html = `
            <button onclick="selectPayer(this, 'public')" class="payer-btn active px-4 py-2 bg-[#FFF8E7] text-jp-accent border border-[#FFEcc0] rounded-lg text-sm font-bold shadow-sm">
                公費包 <i class="fas fa-users ml-1 text-xs"></i>
            </button>
        `;
        appState.users.forEach(u => {
            html += `<button onclick="selectPayer(this, '${u}')" class="payer-btn px-4 py-2 bg-gray-50 text-gray-400 border border-transparent rounded-lg text-sm">${u}</button>`;
        });
        container.innerHTML = html;
        appState.currentPayer = 'public'; // Reset default
    }

    function selectPayer(btn, name) {
        document.querySelectorAll('.payer-btn').forEach(b => {
            b.className = "payer-btn px-4 py-2 bg-gray-50 text-gray-400 border border-transparent rounded-lg text-sm";
        });
        if(name === 'public') {
            btn.className = "payer-btn active px-4 py-2 bg-[#FFF8E7] text-jp-accent border border-[#FFEcc0] rounded-lg text-sm font-bold shadow-sm";
        } else {
            btn.className = "payer-btn active px-4 py-2 bg-jp-text text-white rounded-lg text-sm font-bold shadow-sm";
        }
        appState.currentPayer = name;
    }
    
    function renderCategories() {
        const cats = [
            { id: 'food', icon: 'fa-utensils', name: '餐飲' },
            { id: 'transport', icon: 'fa-car', name: '交通' },
            { id: 'shop', icon: 'fa-shopping-bag', name: '購物' },
            { id: 'hotel', icon: 'fa-bed', name: '住宿' },
            { id: 'other', icon: 'fa-ellipsis-h', name: '其他' }
        ];
        const container = document.getElementById('category-container');
        container.innerHTML = cats.map((c, index) => `
            <button onclick="selectCategory(this, '${c.name}')" class="category-btn ${index===0?'active':''} flex-shrink-0 w-16 h-16 rounded-xl flex flex-col items-center justify-center border border-gray-100 text-gray-400 ${index===0 ? 'border-jp-accent bg-[#FFFCF5] text-jp-accent':''}">
                <i class="fas ${c.icon} text-lg mb-1"></i>
                <span class="text-xs">${c.name}</span>
            </button>
        `).join('');
        appState.currentCategory = '餐飲';
    }

    function selectCategory(btn, name) {
        document.querySelectorAll('.category-btn').forEach(b => {
            b.className = "category-btn flex-shrink-0 w-16 h-16 rounded-xl flex flex-col items-center justify-center border border-gray-100 text-gray-400";
        });
        btn.className = "category-btn active flex-shrink-0 w-16 h-16 rounded-xl flex flex-col items-center justify-center border border-jp-accent bg-[#FFFCF5] text-jp-accent";
        appState.currentCategory = name;
    }

    function setSplit(method) {
        appState.currentSplit = method;
        document.querySelectorAll('.split-btn').forEach(b => {
            b.classList.remove('active', 'bg-[#4A4A4A]', 'text-white', 'font-bold');
            b.classList.add('text-gray-400');
        });
        const activeBtn = document.getElementById(`split-${method}`);
        activeBtn.classList.remove('text-gray-400');
        activeBtn.classList.add('active');
    }

    function submitTransaction() {
        const amount = parseFloat(document.getElementById('amount-input').value);
        const note = document.getElementById('note-input').value;
        if(!amount) return alert("請輸入金額");

        // Logic
        if (appState.currentSplit === 'deposit') {
             // Deposit into public fund
             let val = amount;
             if(appState.currency === 'TWD') val = amount * 1.1; // Simple exchange rate
             appState.fundBalance += val;
        } else {
            // Expense
            if(appState.currentPayer === 'public') {
                let val = amount;
                if(appState.currency === 'TWD') val = amount * 1.1;
                appState.fundBalance -= val;
            }
        }

        const newTx = {
            date: new Date().toLocaleString(),
            type: appState.currentSplit,
            amount: amount,
            currency: appState.currency,
            payer: appState.currentPayer,
            category: appState.currentCategory,
            note: note || '無備註'
        };
        
        appState.transactions.unshift(newTx); // Add to top
        saveState();
        
        document.getElementById('amount-input').value = '';
        document.getElementById('note-input').value = '';
        alert("已記錄！");
    }

    function clearTransactions() {
        if(confirm("確定清空交易紀錄與公費餘額？")) {
            appState.transactions = [];
            appState.fundBalance = 0;
            saveState();
        }
    }

    function updateFundDisplay() {
        const formatted = Math.round(appState.fundBalance).toLocaleString();
        document.getElementById('public-fund-display').innerText = `฿ ${formatted}`;
        document.getElementById('home-balance').innerText = `公費: ฿${formatted}`;
    }

    function renderTransactionHistory() {
        const container = document.getElementById('transaction-history');
        if(appState.transactions.length === 0) {
            container.innerHTML = '<p class="text-xs text-gray-300 text-center py-4">尚無紀錄</p>';
            return;
        }
        
        container.innerHTML = appState.transactions.slice(0, 10).map(tx => `
            <div class="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center border border-gray-50">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 text-xs">
                        ${tx.payer.substring(0,1)}
                    </div>
                    <div>
                        <p class="text-sm text-jp-text font-bold">${tx.note}</p>
                        <p class="text-[10px] text-gray-400">${tx.category} · ${tx.type === 'deposit' ? '入金' : '支出'}</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block text-sm font-bold ${tx.type==='deposit' ? 'text-green-500' : 'text-jp-text'}">
                        ${tx.type==='deposit' ? '+' : '-'} ${tx.amount}
                    </span>
                    <span class="text-[10px] text-gray-300">${tx.currency}</span>
                </div>
            </div>
        `).join('');
    }

    // --- CHECKLIST LOGIC ---
    function renderChecklist() {
        const container = document.getElementById('checklist-container');
        let totalItems = 0;
        let checkedItems = 0;

        let html = appState.checklist.map((group, gIndex) => {
            const groupTotal = group.items.length;
            const groupChecked = group.items.filter(i => i.checked).length;
            totalItems += groupTotal;
            checkedItems += groupChecked;
            const percent = groupTotal === 0 ? 0 : Math.round((groupChecked / groupTotal) * 100);
            
            return `
            <div class="bg-white rounded-xl p-4 shadow-soft mb-4">
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-bold text-jp-text">${group.title}</span>
                    <span class="text-xs text-gray-400">${groupChecked}/${groupTotal}</span>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-1.5 mb-4">
                    <div class="bg-jp-green h-1.5 rounded-full transition-all duration-500" style="width: ${percent}%"></div>
                </div>
                <div class="space-y-3">
                    ${group.items.map((item, iIndex) => `
                        <label class="flex items-center gap-3 text-sm text-gray-600 cursor-pointer">
                            <input type="checkbox" onchange="toggleCheck(${gIndex}, ${iIndex})" ${item.checked ? 'checked' : ''} class="w-4 h-4 text-jp-green rounded focus:ring-jp-green accent-jp-green">
                            <span class="${item.checked ? 'line-through text-gray-300' : ''}">${item.name}</span>
                        </label>
                    `).join('')}
                </div>
            </div>`;
        }).join('');

        container.innerHTML = html;
        const globalPercent = totalItems === 0 ? 0 : Math.round((checkedItems / totalItems) * 100);
        document.getElementById('home-check-progress').innerText = `完成度 ${globalPercent}%`;
    }

    function toggleCheck(gIndex, iIndex) {
        appState.checklist[gIndex].items[iIndex].checked = !appState.checklist[gIndex].items[iIndex].checked;
        saveState();
        renderChecklist();
    }

    function addChecklistItem() {
        const category = prompt("分類 (例如: 隨身包):", "隨身包");
        if(!category) return;
        const item = prompt("物品名稱:", "護照影本");
        if(!item) return;

        let group = appState.checklist.find(g => g.title === category);
        if(group) {
            group.items.push({ name: item, checked: false });
        } else {
            appState.checklist.push({
                title: category,
                items: [{ name: item, checked: false }]
            });
        }
        saveState();
        renderChecklist();
    }

    // --- SETTINGS LOGIC ---
    function renderSettingsUsers() {
        const container = document.getElementById('settings-users');
        container.innerHTML = appState.users.map(u => 
            `<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">${u}</span>`
        ).join('');
    }

    function editUsers() {
        const newName = prompt("新增旅伴名字:", "");
        if(newName && !appState.users.includes(newName)) {
            appState.users.push(newName);
            saveState();
            renderSettingsUsers();
            renderPayers(); // Update in account tab
        }
    }
</script>

</body>
</html>
