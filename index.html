<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 曼谷聖誕跨年 - 泰廢了 (雲端加強版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-bg': '#F9F8F4',
                        'jp-text': '#4A4A4A',
                        'jp-accent': '#C6A568', // 金色
                        'jp-blue': '#6B8EAD',
                        'jp-green': '#8DA399',
                        'jp-red': '#D67D7D',
                    },
                    fontFamily: {
                        sans: ['"Zen Kaku Gothic New"', '"Noto Sans TC"', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px rgba(0, 0, 0, 0.03)',
                        'gold': '0 4px 15px rgba(198, 165, 104, 0.15)',
                    }
                }
            }
        }
    </script>
   
    <style>
        body { background-color: #F0F0F0; font-family: 'Zen Kaku Gothic New', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        .app-container { background-color: #F9F8F4; max-width: 430px; margin: 0 auto; min-height: 100vh; padding-bottom: 100px; overflow-x: hidden; position: relative; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Timeline */
        .timeline-item { position: relative; padding-left: 24px; padding-bottom: 24px; border-left: 2px solid #E5E7EB; }
        .timeline-item:last-child { border-left: 2px solid transparent; }
        .timeline-dot { position: absolute; left: -7px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: #C6A568; border: 2px solid #F9F8F4; }
        .timeline-time { font-size: 11px; font-weight: bold; color: #6B8EAD; margin-bottom: 4px; display: block; }

        /* Accounting Buttons */
        .cat-btn.active { border: 1px solid #C6A568; background-color: #FFFCF5; color: #C6A568; }
        .payer-btn.active { background-color: #FFF9E6; border: 1px solid #C6A568; color: #C6A568; font-weight: bold; }
        .split-btn.active { background-color: #4A4A4A; color: white; }

        /* Navbar Active State */
        .nav-btn.active { color: #C6A568; }
        .nav-btn.active i { transform: scale(1.1); transition: 0.2s; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        
        /* Edit Buttons on Itinerary */
        .edit-spot-btn { opacity: 0.3; transition: 0.2s; }
        .timeline-item:hover .edit-spot-btn { opacity: 1; }
    </style>
</head>
<body>

<div class="app-container">
    
    <header class="sticky top-0 z-50 bg-[#F9F8F4]/95 backdrop-blur-sm px-5 py-4 flex justify-between items-end border-b border-gray-100">
        <div>
            <p class="text-[10px] text-gray-400 tracking-widest mb-1">DEC 23 - DEC 27</p>
            <h1 class="text-xl font-bold text-jp-text tracking-wide leading-tight">2025 曼谷聖誕跨年<br><span class="text-jp-accent text-lg">- 泰廢了 -</span></h1>
        </div>
        <div class="text-center">
             <span class="block text-[10px] text-gray-400">曼谷</span>
             <span class="text-sm font-medium" id="header-weather">Loading...</span>
        </div>
    </header>

    <div id="tab-home" class="section active px-5 py-4">
        
        <div class="bg-white rounded-2xl p-4 shadow-soft mb-6">
            <h3 class="text-sm font-bold text-jp-text mb-2">求生泰語翻譯</h3>
            <div class="flex gap-2">
                <input type="text" id="thai-input" placeholder="輸入中文 (例: 不要香菜)" class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-jp-accent">
                <button onclick="translateThai()" class="w-10 h-10 bg-jp-green/10 rounded-lg flex items-center justify-center text-jp-green active:scale-95 transition">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
            <p class="text-[10px] text-gray-400 mt-2 text-right">點擊喇叭開啟 Google 翻譯發音</p>
        </div>

        <h3 class="text-sm font-bold text-gray-400 mb-3 ml-1 uppercase tracking-wider">Quick Access</h3>
        <div class="grid grid-cols-2 gap-3 mb-20">
            <button onclick="switchTab('tab-itinerary')" class="bg-white p-4 rounded-xl shadow-soft text-left flex flex-col justify-between h-24 relative overflow-hidden group active:scale-95 transition">
                <div class="absolute top-0 right-0 w-12 h-12 bg-jp-blue/10 rounded-full -mr-4 -mt-4"></div>
                <i class="fas fa-map-marked-alt text-jp-blue text-xl relative z-10"></i>
                <div>
                    <span class="text-sm font-bold block text-jp-text">行程規劃</span>
                    <span class="text-xs text-gray-400 font-sans" id="current-date-display">Dec 23</span>
                </div>
            </button>

            <button onclick="switchTab('tab-account')" class="bg-white p-4 rounded-xl shadow-soft text-left flex flex-col justify-between h-24 border border-jp-accent/20 active:scale-95 transition">
                <div class="flex justify-between">
                    <i class="fas fa-calculator text-jp-red text-xl"></i>
                    <span class="text-[10px] bg-gray-100 px-1 rounded text-gray-500" id="dash-fund">公費: $0</span>
                </div>
                <div>
                    <span class="text-sm font-bold block text-jp-text">智慧記帳</span>
                    <span class="text-xs text-gray-400">點擊記帳</span>
                </div>
            </button>

             <button onclick="switchTab('tab-checklist')" class="bg-white p-4 rounded-xl shadow-soft text-left flex flex-col justify-between h-24 active:scale-95 transition">
                <i class="fas fa-tasks text-jp-accent text-xl"></i>
                <div>
                    <span class="text-sm font-bold block text-jp-text">行李清單</span>
                    <span class="text-xs text-gray-400" id="home-check-progress">完成度 0%</span>
                </div>
            </button>
        </div>
    </div>

    <div id="tab-itinerary" class="section pb-24">
        <div class="sticky top-[72px] z-40 bg-[#F9F8F4] px-5 py-2 mb-2 shadow-sm flex justify-between items-center">
            <div class="flex overflow-x-auto hide-scrollbar gap-3 pb-2 flex-1" id="day-tabs"></div>
            <button onclick="openEditSpot()" class="ml-2 w-8 h-8 rounded-full bg-jp-text text-white flex items-center justify-center shadow-md flex-shrink-0"><i class="fas fa-plus text-xs"></i></button>
        </div>

        <div id="itinerary-content" class="px-5 space-y-4 min-h-[50vh]">
            </div>

        <div class="px-5 mt-8 mb-4">
             <h3 class="text-sm font-bold text-gray-400 mb-2 uppercase">住宿資訊</h3>
             <div class="bg-white rounded-xl p-3 shadow-sm border-l-4 border-jp-blue mb-2">
                 <p class="text-xs font-bold text-jp-blue">12/23 - 12/25 (唐人街)</p>
                 <p class="text-sm font-bold text-jp-text">B2 唐人街耀華力尊尚飯店</p>
                 <a href="https://maps.google.com/?q=B2+Bangkok+Chinatown" target="_blank" class="text-[10px] text-gray-400 underline"><i class="fas fa-map-marker-alt"></i> 查看地圖</a>
             </div>
             <div class="bg-white rounded-xl p-3 shadow-sm border-l-4 border-jp-accent">
                 <p class="text-xs font-bold text-jp-accent">12/25 - 12/27 (通羅)</p>
                 <p class="text-sm font-bold text-jp-text">曼谷茉莉花59號飯店</p>
                 <a href="https://maps.google.com/?q=Jasmine+59+Hotel" target="_blank" class="text-[10px] text-gray-400 underline"><i class="fas fa-map-marker-alt"></i> 查看地圖</a>
             </div>
        </div>
    </div>

    <div id="tab-account" class="section px-4 py-4 pb-24">
        <div class="bg-white rounded-2xl shadow-gold p-5 border border-gray-50 relative">
            <div class="absolute top-4 right-4 text-right">
                <p class="text-[10px] text-gray-400">公費包餘額 (THB)</p>
                <p class="text-xl font-bold text-jp-accent" id="acc-fund-display">฿ 0</p>
            </div>

            <h2 class="text-lg font-bold text-jp-text mb-4">新增記帳</h2>

            <div class="flex justify-between gap-2 overflow-x-auto hide-scrollbar mb-4" id="cat-container"></div>

            <div class="flex items-end gap-3 mb-4 border-b border-gray-100 pb-2">
                 <div class="flex bg-gray-50 rounded-lg p-1">
                    <button onclick="setCurrency('TWD')" id="cur-twd" class="px-3 py-1 text-xs rounded text-gray-400 font-bold">TWD</button>
                    <button onclick="setCurrency('THB')" id="cur-thb" class="px-3 py-1 text-xs rounded bg-white shadow-sm text-jp-text font-bold">THB</button>
                </div>
                <input type="number" id="amt-input" placeholder="0" class="flex-1 text-right text-3xl font-bold text-jp-text bg-transparent outline-none">
            </div>

            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-xs text-gray-400">付款人</p>
                    <button onclick="editUsers()" class="text-[10px] text-blue-400 underline">編輯名單</button>
                </div>
                <div class="flex flex-wrap gap-2" id="payer-container"></div>
            </div>

            <div class="mb-4">
                <p class="text-xs text-gray-400 mb-2">分攤模式</p>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setSplit('shared')" id="split-shared" class="split-btn active py-2 rounded-lg text-xs border border-gray-200">共同分攤 (扣公費/記帳)</button>
                    <button onclick="setSplit('deposit')" id="split-deposit" class="split-btn py-2 rounded-lg text-xs border border-gray-200 text-gray-400">公費入金 (存錢)</button>
                    <button onclick="setSplit('own')" id="split-own" class="split-btn py-2 rounded-lg text-xs border border-gray-200 text-gray-400">個人自付</button>
                    <button onclick="setSplit('advance')" id="split-advance" class="split-btn py-2 rounded-lg text-xs border border-gray-200 text-gray-400">幫人代墊</button>
                </div>
            </div>

            <div class="flex gap-2 mb-4">
                <button class="w-10 h-10 rounded-full border border-gray-200 flex items-center justify-center text-gray-400"><i class="fas fa-camera"></i></button>
                <input type="text" id="note-input" placeholder="備註 (如: 7-11)" class="flex-1 bg-gray-50 rounded-lg px-3 text-sm outline-none">
            </div>

            <button onclick="submitTx()" class="w-full bg-jp-text text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">新增紀錄</button>
        </div>

        <div class="mt-6">
            <div class="flex justify-between items-center mb-2 px-1">
                 <h3 class="text-sm font-bold text-gray-500">近期紀錄</h3>
                <button onclick="clearTx()" class="text-xs text-red-300">清空</button>
            </div>
            <div id="tx-history" class="space-y-2 pb-10"></div>
        </div>
    </div>
    
    <div id="tab-checklist" class="section px-5 py-4 pb-24">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">行李清單</h2>
            <div class="flex gap-2">
                <button onclick="addChecklistCategory()" class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center"><i class="fas fa-folder-plus text-xs"></i></button>
                <button onclick="addChecklistItem()" class="w-8 h-8 rounded-full bg-jp-accent text-white flex items-center justify-center shadow-md"><i class="fas fa-plus text-xs"></i></button>
            </div>
        </div>
         <div id="checklist-container"></div>
    </div>

    <div id="tab-settings" class="section px-5 py-4 pb-24">
        <h2 class="text-xl font-bold mb-6">資料同步 & 設定</h2>
        
        <div class="bg-white rounded-2xl shadow-soft p-5 mb-6 border border-jp-green/30 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-16 h-16 bg-jp-green/10 rounded-full -mr-6 -mt-6"></div>
            <h3 class="font-bold text-jp-text mb-2"><i class="fab fa-google-drive text-jp-green mr-2"></i>雲端資料庫 (Google Sheets)</h3>
            <p class="text-xs text-gray-500 mb-4 leading-relaxed">
               將所有行程與記帳同步至 Google 試算表。<br>
               <span class="text-[10px] text-gray-400">需連網使用，API 位址已設定。</span>
            </p>
            <div class="flex gap-3">
                 <button onclick="syncToCloud('upload')" id="btn-upload" class="flex-1 bg-jp-text text-white py-3 rounded-lg text-sm shadow hover:opacity-90 active:scale-95 transition flex items-center justify-center gap-2">
                    <i class="fas fa-cloud-upload-alt"></i> 上傳備份
                </button>
                <button onclick="syncToCloud('download')" id="btn-download" class="flex-1 bg-white border border-jp-text text-jp-text py-3 rounded-lg text-sm shadow hover:bg-gray-50 active:scale-95 transition flex items-center justify-center gap-2">
                    <i class="fas fa-cloud-download-alt"></i> 下載覆蓋
                </button>
            </div>
            <p id="sync-status" class="text-[10px] text-center mt-2 text-gray-400 h-4"></p>
        </div>

        <div class="bg-white rounded-2xl shadow-soft p-5 mb-6 border border-jp-blue/20">
            <h3 class="font-bold text-jp-blue mb-2"><i class="fas fa-qrcode mr-2"></i>快速轉移 (無網路用)</h3>
            <p class="text-xs text-gray-500 mb-4">產生代碼傳給朋友。</p>
            <div class="flex gap-3">
                 <button onclick="exportData()" class="flex-1 bg-jp-blue text-white py-3 rounded-lg text-sm shadow hover:opacity-90">
                    <i class="fas fa-copy mr-1"></i> 複製代碼
                </button>
                <button onclick="openImportModal()" class="flex-1 bg-gray-600 text-white py-3 rounded-lg text-sm shadow hover:opacity-90">
                    <i class="fas fa-paste mr-1"></i> 貼上匯入
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-soft p-5">
            <h3 class="font-bold text-jp-text mb-3">緊急聯絡電話</h3>
            <div class="space-y-2">
                <div class="flex justify-between text-sm border-b border-gray-50 pb-2"><span>觀光警察</span><span class="font-bold text-red-500">1155</span></div>
                <div class="flex justify-between text-sm border-b border-gray-50 pb-2"><span>救護車</span><span class="font-bold text-red-500">1669</span></div>
                <div class="flex justify-between text-sm"><span>駐泰代表處</span><span class="font-bold text-blue-500">+66-81-666-4006</span></div>
            </div>
        </div>
        
        <div class="mt-8 text-center">
             <button onclick="hardReset()" class="text-xs text-red-400 underline p-2">重置所有 App 資料 (慎用)</button>
        </div>
    </div>

    <nav class="fixed bottom-6 left-5 right-5 h-16 bg-white/95 backdrop-blur rounded-2xl flex justify-around items-center shadow-gold z-50 border border-gray-100">
        <button onclick="switchTab('tab-home')" class="nav-btn active flex flex-col items-center gap-1 text-gray-400" data-target="tab-home">
            <i class="fas fa-home text-lg"></i><span class="text-[10px]">首頁</span>
        </button>
        <button onclick="switchTab('tab-itinerary')" class="nav-btn flex flex-col items-center gap-1 text-gray-400" data-target="tab-itinerary">
            <i class="fas fa-map-marked-alt text-lg"></i><span class="text-[10px]">行程</span>
        </button>
        <div class="relative -top-6">
            <button onclick="switchTab('tab-account')" class="w-14 h-14 bg-jp-text rounded-full shadow-lg flex items-center justify-center text-white text-xl transform hover:scale-105 transition active:scale-95 border-4 border-[#F9F8F4]">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        <button onclick="switchTab('tab-checklist')" class="nav-btn flex flex-col items-center gap-1 text-gray-400" data-target="tab-checklist">
            <i class="fas fa-check-circle text-lg"></i><span class="text-[10px]">清單</span>
        </button>
        <button onclick="switchTab('tab-settings')" class="nav-btn flex flex-col items-center gap-1 text-gray-400" data-target="tab-settings">
            <i class="fas fa-cog text-lg"></i><span class="text-[10px]">我的</span>
        </button>
    </nav>

    <div id="import-modal" class="modal-overlay">
        <div class="bg-white w-4/5 rounded-2xl p-5 shadow-2xl">
            <h3 class="font-bold text-lg mb-2">貼上資料代碼</h3>
            <textarea id="import-area" class="w-full h-32 bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs mb-4" placeholder="請在此貼上朋友傳來的代碼..."></textarea>
            <div class="flex gap-2">
                <button onclick="closeModal('import-modal')" class="flex-1 py-2 rounded-lg border border-gray-200 text-sm">取消</button>
                <button onclick="confirmImport()" class="flex-1 py-2 rounded-lg bg-jp-text text-white text-sm">確定匯入</button>
            </div>
        </div>
    </div>
    
    <div id="advance-modal" class="modal-overlay">
        <div class="bg-white w-4/5 rounded-2xl p-5 shadow-2xl">
            <h3 class="font-bold text-lg mb-2">幫誰代墊?</h3>
            <div id="advance-list" class="space-y-2 mb-4"></div>
            <div class="flex gap-2">
                <button onclick="closeModal('advance-modal')" class="flex-1 py-2 rounded-lg border border-gray-200 text-sm">取消</button>
                <button onclick="confirmAdvance()" class="flex-1 py-2 rounded-lg bg-jp-text text-white text-sm">確定</button>
            </div>
        </div>
    </div>

    <div id="itinerary-modal" class="modal-overlay">
        <div class="bg-white w-[90%] rounded-2xl p-5 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4 text-jp-text" id="spot-modal-title">編輯景點</h3>
            <input type="hidden" id="spot-index">
            
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-400 block mb-1">時間</label>
                    <input type="text" id="spot-time" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm" placeholder="例如: 10:00">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">景點名稱</label>
                    <input type="text" id="spot-name" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm font-bold" placeholder="例如: 鄭王廟">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">簡短描述</label>
                    <input type="text" id="spot-desc" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm" placeholder="例如: 必拍古蹟">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">Google Map 連結</label>
                        <input type="text" id="spot-link" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-xs" placeholder="https://...">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">攻略關鍵字</label>
                        <input type="text" id="spot-keyword" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-xs" placeholder="例如: 鄭王廟 穿搭">
                    </div>
                </div>
                 <div>
                    <label class="text-xs text-gray-400 block mb-1">圖示代碼 (FontAwesome)</label>
                    <input type="text" id="spot-icon" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-xs" value="fa-map-marker-alt">
                </div>
            </div>

            <div class="flex gap-2 mt-6">
                <button onclick="deleteSpot()" id="btn-delete-spot" class="px-4 py-2 rounded-lg bg-red-50 text-red-400 text-sm"><i class="fas fa-trash"></i></button>
                <button onclick="closeModal('itinerary-modal')" class="flex-1 py-2 rounded-lg border border-gray-200 text-sm">取消</button>
                <button onclick="saveSpot()" class="flex-1 py-2 rounded-lg bg-jp-text text-white text-sm">儲存</button>
            </div>
        </div>
    </div>

</div>

<script>
    // --- CONFIG ---
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxYeyHua8VRjHu3dHbP3glwWcFf5zClFG_drBD9gR_j9MZpcGf6uajQUzmOw_Au_o0o/exec';

    // --- DEFAULT DATA ---
    const DEFAULT_ITINERARY = [
        {
            day: 1, date: "12/23 (二)", desc: "抵達曼谷", 
            spots: [
                { time: "18:00", name: "高雄機場出發", desc: "泰國亞航 FD235 ✈️", icon: "fa-plane", color: "text-blue-500" },
                { time: "22:30", name: "機場包車接機", desc: "前往 B2 飯店", icon: "fa-car", color: "text-green-600", highlight: true },
                { time: "Late", name: "唐人街宵夜", desc: "Check-in 後覓食", icon: "fa-utensils", color: "text-orange-500", keyword: "曼谷唐人街美食" }
            ]
        },
        {
            day: 2, date: "12/24 (三)", desc: "舊城古蹟巡禮", 
            spots: [
                { time: "Day", name: "石龍軍路", desc: "文青散策 / 美食", icon: "fa-walking", color: "text-gray-500", keyword: "石龍軍路美食" },
                { time: "10:00", name: "臥佛寺 & 鄭王廟", desc: "必拍古蹟", icon: "fa-gopuram", color: "text-yellow-600", keyword: "鄭王廟 拍照" },
                { time: "19:00", name: "昭披耶河晚餐", desc: "River City 郵輪", icon: "fa-ship", color: "text-blue-600", keyword: "昭披耶河遊船推薦" }
            ]
        },
        { day: 3, date: "12/25 (四)", desc: "通羅時尚漫遊", spots: [] },
        { day: 4, date: "12/26 (五)", desc: "水上市場一日遊", spots: [] },
        { day: 5, date: "12/27 (六)", desc: "返台", spots: [] }
    ];

    let state = {
        users: ['小朱', '簡哥', '公費包', '團員A'],
        fundBalance: 0,
        currency: 'THB',
        transactions: [],
        checklist: [
            { title: "證件文件", items: [{name: "護照", checked: true}, {name: "電子機票", checked: false}] },
            { title: "電子用品", items: [{name: "網卡/針", checked: false}, {name: "行動電源", checked: false}] }
        ],
        itinerary: DEFAULT_ITINERARY, // Now part of state
        currentDay: 0
    };

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        updateDate();
        fetchWeather();
        renderDayTabs();
        renderItinerary();
        renderAccCats();
        renderPayers();
        updateFundDisplay();
        renderHistory();
        renderChecklist();
    });

    // --- HOME ---
    function updateDate() {
        document.getElementById('current-date-display').innerText = new Date().toLocaleDateString('en-US', {month:'short', day:'numeric'});
    }
    async function fetchWeather() {
        try {
            const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=13.75&longitude=100.50&current_weather=true');
            const data = await res.json();
            document.getElementById('header-weather').innerHTML = `${Math.round(data.current_weather.temperature)}°C <i class="fas fa-sun text-yellow-400"></i>`;
        } catch { document.getElementById('header-weather').innerText = "28°C"; }
    }
    function translateThai() {
        const txt = document.getElementById('thai-input').value;
        if(txt) window.open(`https://translate.google.com/?sl=zh-TW&tl=th&text=${encodeURIComponent(txt)}&op=translate`, '_blank');
    }

    // --- ITINERARY (CRUD) ---
    function renderDayTabs() {
        const c = document.getElementById('day-tabs');
        c.innerHTML = state.itinerary.map((d, i) => `
            <button onclick="setDay(${i})" class="flex-shrink-0 px-4 py-2 rounded-xl border ${state.currentDay===i ? 'bg-jp-text text-white border-jp-text shadow-md' : 'bg-white text-gray-400 border-gray-100'}">
                <span class="block text-xs font-bold">Day ${d.day}</span>
                <span class="text-[10px] whitespace-nowrap">${d.date.split(' ')[0]}</span>
            </button>
        `).join('');
    }
    function setDay(i) { state.currentDay = i; renderDayTabs(); renderItinerary(); }
    
    function renderItinerary() {
        const d = state.itinerary[state.currentDay];
        const c = document.getElementById('itinerary-content');
        if(!d.spots || d.spots.length === 0) {
            c.innerHTML = `<div class="text-center py-10 text-gray-400 text-sm">點擊右上角 + 新增行程</div>`;
            return;
        }
        c.innerHTML = d.spots.map((s, idx) => `
            <div class="timeline-item group">
                <div class="timeline-dot" style="${s.highlight ? 'background:#ef4444; border-color:#fee2e2;' : ''}"></div>
                <span class="timeline-time ${s.highlight ? 'text-red-500' : ''}">${s.time}</span>
                
                <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-50 relative">
                    <button onclick="openEditSpot(${idx})" class="absolute top-2 right-2 text-gray-300 hover:text-jp-accent p-1 edit-spot-btn"><i class="fas fa-pen text-xs"></i></button>

                    <div class="flex justify-between items-start pr-6">
                        <p class="text-sm font-bold text-jp-text"><i class="fas ${s.icon} ${s.color || 'text-gray-500'} mr-1"></i> ${s.name}</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 mb-2">${s.desc}</p>
                    
                    <div class="flex gap-2 mt-2 border-t border-gray-50 pt-2">
                        ${s.link ? `<a href="${s.link}" target="_blank" class="text-[10px] bg-blue-50 text-blue-500 px-2 py-1 rounded hover:bg-blue-100"><i class="fas fa-map-marker-alt"></i> 地圖</a>` : ''}
                        ${s.keyword ? `<a href="https://www.google.com/search?q=${encodeURIComponent(s.keyword)}" target="_blank" class="text-[10px] bg-orange-50 text-orange-500 px-2 py-1 rounded hover:bg-orange-100"><i class="fab fa-google"></i> 搜攻略</a>` : ''}
                        ${!s.link && !s.keyword ? '<span class="text-[10px] text-gray-300 italic">無連結</span>' : ''}
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Itinerary Modal Logic
    let currentEditIndex = -1;

    function openEditSpot(index = -1) {
        currentEditIndex = index;
        const modal = document.getElementById('itinerary-modal');
        const title = document.getElementById('spot-modal-title');
        const btnDel = document.getElementById('btn-delete-spot');
        
        // Inputs
        const iTime = document.getElementById('spot-time');
        const iName = document.getElementById('spot-name');
        const iDesc = document.getElementById('spot-desc');
        const iLink = document.getElementById('spot-link');
        const iKey = document.getElementById('spot-keyword');
        const iIcon = document.getElementById('spot-icon');

        if (index === -1) {
            title.innerText = "新增行程";
            btnDel.style.display = 'none';
            iTime.value = ""; iName.value = ""; iDesc.value = ""; iLink.value = ""; iKey.value = ""; iIcon.value = "fa-map-marker-alt";
        } else {
            title.innerText = "修改行程";
            btnDel.style.display = 'block';
            const spot = state.itinerary[state.currentDay].spots[index];
            iTime.value = spot.time || "";
            iName.value = spot.name || "";
            iDesc.value = spot.desc || "";
            iLink.value = spot.link || "";
            iKey.value = spot.keyword || "";
            iIcon.value = spot.icon || "fa-map-marker-alt";
        }
        modal.classList.add('open');
    }

    function saveSpot() {
        const spot = {
            time: document.getElementById('spot-time').value,
            name: document.getElementById('spot-name').value,
            desc: document.getElementById('spot-desc').value,
            link: document.getElementById('spot-link').value,
            keyword: document.getElementById('spot-keyword').value,
            icon: document.getElementById('spot-icon').value,
            color: 'text-gray-500' // default
        };

        if (!spot.name) return alert("請輸入名稱");

        if (currentEditIndex === -1) {
            // Create
            if (!state.itinerary[state.currentDay].spots) state.itinerary[state.currentDay].spots = [];
            state.itinerary[state.currentDay].spots.push(spot);
            // Simple sort by time (optional, rough string sort)
            state.itinerary[state.currentDay].spots.sort((a,b) => a.time.localeCompare(b.time));
        } else {
            // Update
            state.itinerary[state.currentDay].spots[currentEditIndex] = spot;
        }

        saveData();
        renderItinerary();
        closeModal('itinerary-modal');
    }

    function deleteSpot() {
        if(confirm("確定刪除此行程?")) {
            state.itinerary[state.currentDay].spots.splice(currentEditIndex, 1);
            saveData();
            renderItinerary();
            closeModal('itinerary-modal');
        }
    }

    // --- ACCOUNTING ---
    let acc = { cat: '餐飲', payer: '公費包', split: 'shared', cur: 'THB' };
    function renderAccCats() {
        const cats = [{n:'餐飲',i:'fa-utensils'}, {n:'交通',i:'fa-car'}, {n:'購物',i:'fa-shopping-bag'}, {n:'住宿',i:'fa-bed'}, {n:'其他',i:'fa-ellipsis-h'}];
        document.getElementById('cat-container').innerHTML = cats.map((c, i) => `
            <button onclick="setCat('${c.n}', this)" class="cat-btn ${i===0?'active':''} flex-shrink-0 w-16 h-16 rounded-xl flex flex-col items-center justify-center bg-white border border-gray-100">
                <i class="fas ${c.i} text-lg mb-1"></i><span class="text-xs">${c.n}</span>
            </button>
        `).join('');
    }
    function setCat(n, el) { acc.cat = n; document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); }
    
    function renderPayers() {
        document.getElementById('payer-container').innerHTML = state.users.map(u => `
            <button onclick="setPayer('${u}', this)" class="payer-btn ${u==='公費包'?'active':''} px-3 py-1 bg-gray-50 text-gray-400 rounded-lg text-xs border border-transparent">${u}</button>
        `).join('');
    }
    function setPayer(u, el) { acc.payer = u; document.querySelectorAll('.payer-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); }

    function setCurrency(c) { 
        acc.cur = c;
        document.getElementById('cur-twd').className = c==='TWD' ? "px-3 py-1 text-xs rounded bg-white shadow-sm text-jp-text font-bold" : "px-3 py-1 text-xs rounded text-gray-400 font-bold";
        document.getElementById('cur-thb').className = c==='THB' ? "px-3 py-1 text-xs rounded bg-white shadow-sm text-jp-text font-bold" : "px-3 py-1 text-xs rounded text-gray-400 font-bold";
    }

    function setSplit(t) {
        acc.split = t;
        document.querySelectorAll('.split-btn').forEach(b => { b.classList.remove('active'); b.classList.add('text-gray-400'); });
        const btn = document.getElementById(`split-${t}`);
        btn.classList.add('active'); btn.classList.remove('text-gray-400');
    }

    function submitTx() {
        const amt = parseFloat(document.getElementById('amt-input').value);
        const note = document.getElementById('note-input').value;
        if (!amt) return alert("請輸入金額");

        if (acc.split === 'advance') {
            document.getElementById('advance-modal').classList.add('open');
            const list = document.getElementById('advance-list');
            list.innerHTML = state.users.filter(u => u !== '公費包').map(u => `
                <label class="flex items-center gap-2 p-2 bg-gray-50 rounded"><input type="checkbox" value="${u}"> ${u}</label>
            `).join('');
            return; 
        }

        processTx(amt, note, acc.payer, acc.split, acc.cat, acc.cur, []);
    }

    function confirmAdvance() {
        const amt = parseFloat(document.getElementById('amt-input').value);
        const note = document.getElementById('note-input').value;
        const checked = Array.from(document.querySelectorAll('#advance-list input:checked')).map(cb => cb.value);
        if(checked.length === 0) return alert("請選擇代墊對象");
        processTx(amt, note, acc.payer, 'advance', acc.cat, acc.cur, checked);
        closeModal('advance-modal');
    }

    function processTx(amt, note, payer, split, cat, cur, targets) {
        if(split === 'deposit') {
            state.fundBalance += amt;
        } else if (payer === '公費包') {
            state.fundBalance -= amt;
        }

        state.transactions.unshift({ date: new Date().toLocaleString(), amt, note, payer, split, cat, cur, targets });
        saveData();
        updateFundDisplay();
        renderHistory();
        document.getElementById('amt-input').value = '';
        document.getElementById('note-input').value = '';
        alert("已記錄");
    }

    function updateFundDisplay() {
        const txt = `฿ ${state.fundBalance.toLocaleString()}`;
        document.getElementById('acc-fund-display').innerText = txt;
        document.getElementById('dash-fund').innerText = "公費: " + txt;
    }

    function renderHistory() {
        document.getElementById('tx-history').innerHTML = state.transactions.slice(0, 10).map(t => `
            <div class="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center border border-gray-50">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs text-gray-500">${t.payer[0]}</div>
                     <div>
                        <p class="text-sm font-bold text-jp-text">${t.note || t.cat}</p>
                        <p class="text-[10px] text-gray-400">${t.split === 'deposit' ? '入金' : t.split === 'advance' ? `代墊(${t.targets.length})` : '支出'}</p>
                    </div>
                </div>
                <span class="font-bold ${t.split === 'deposit' ? 'text-green-500' : 'text-jp-text'}">${t.split==='deposit' ? '+' : '-'} ${t.amt}</span>
            </div>
        `).join('');
    }
    
    function clearTx() { if(confirm("確定清空?")) { state.transactions=[]; state.fundBalance=0; saveData(); location.reload(); }}
    function editUsers() { 
        const n = prompt("輸入新成員名單 (用逗號分隔)", state.users.join(','));
        if(n) { state.users = n.split(','); saveData(); renderPayers(); }
    }

    // --- CHECKLIST ---
    function renderChecklist() {
        let total=0, checked=0;
        document.getElementById('checklist-container').innerHTML = state.checklist.map((g, gi) => `
            <div class="bg-white rounded-xl p-4 shadow-soft mb-3">
                <div class="flex justify-between mb-2">
                    <input type="text" value="${g.title}" onchange="updateCheckTitle(${gi}, this.value)" class="font-bold text-sm bg-transparent outline-none">
                    <span class="text-xs text-gray-400">${g.items.filter(i=>i.checked).length}/${g.items.length}</span>
                </div>
                <div class="w-full bg-gray-100 h-1 rounded-full mb-3"><div class="bg-jp-green h-1 rounded-full" style="width:${(g.items.filter(i=>i.checked).length/g.items.length)*100}%"></div></div>
                <div class="space-y-2">
                    ${g.items.map((i, ii) => {
                        total++; if(i.checked) checked++;
                        return `<div class="flex items-center justify-between">
                            <label class="flex items-center gap-2 text-sm text-gray-600">
                                <input type="checkbox" ${i.checked?'checked':''} class="accent-jp-green" onchange="toggleCheck(${gi}, ${ii})">
                                <span class="${i.checked?'line-through text-gray-300':''}">${i.name}</span>
                            </label>
                            <button onclick="delCheckItem(${gi}, ${ii})" class="text-gray-200 text-xs"><i class="fas fa-times"></i></button>
                        </div>`;
                    }).join('')}
                    <button onclick="addCheckItemTo(${gi})" class="text-xs text-jp-blue mt-2">+ 新增細項</button>
                </div>
            </div>
        `).join('');
        document.getElementById('home-check-progress').innerText = `完成度 ${total===0?0:Math.round((checked/total)*100)}%`;
    }
    function toggleCheck(gi, ii) { state.checklist[gi].items[ii].checked = !state.checklist[gi].items[ii].checked; saveData(); renderChecklist(); }
    function addChecklistCategory() { state.checklist.push({title:'新分類', items:[]}); saveData(); renderChecklist(); }
    function addChecklistItem() { const n = prompt("項目名稱"); if(n) { state.checklist[0].items.push({name:n, checked:false}); saveData(); renderChecklist(); }} 
    function addCheckItemTo(gi) { const n = prompt("項目名稱"); if(n) { state.checklist[gi].items.push({name:n, checked:false}); saveData(); renderChecklist(); }}
    function updateCheckTitle(gi, v) { state.checklist[gi].title = v; saveData(); }
    function delCheckItem(gi, ii) { state.checklist[gi].items.splice(ii,1); saveData(); renderChecklist(); }

    // --- SYSTEM & GAS SYNC ---
    function switchTab(id) {
        document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('active'); b.style.color=''; });
        const btn = document.querySelector(`.nav-btn[data-target="${id}"]`);
        if(btn) btn.classList.add('active');
    }
    
    function saveData() { localStorage.setItem('bkk_2025_v4', JSON.stringify(state)); }
    
    function loadData() { 
        const d = localStorage.getItem('bkk_2025_v4');
        if(d) {
            try { 
                const p = JSON.parse(d);
                state = { ...state, ...p }; // Merge
            } catch(e) { console.log('Reset data'); }
        }
    }

    // --- GOOGLE APPS SCRIPT SYNC ---
    async function syncToCloud(action) {
        const btn = document.getElementById(action === 'upload' ? 'btn-upload' : 'btn-download');
        const status = document.getElementById('sync-status');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 處理中...';
        btn.disabled = true;
        status.innerText = "連線 Google 伺服器中...";

        try {
            if (action === 'upload') {
                // Post data
                // Note: GAS POST requests often have CORS issues or redirects.
                // Using no-cors mode is standard for simple fire-and-forget, but we can't read response.
                // However, standard fetch often works if GAS is set to "Anyone".
                const payload = JSON.stringify(state);
                
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Critical for simple GAS Web Apps
                    headers: { 'Content-Type': 'application/json' },
                    body: payload
                });
                // Since 'no-cors' returns opaque response, we assume success if no error thrown
                status.innerText = "上傳指令已發送 (請稍後檢查 Sheet)";
                alert("已發送資料至 Google Sheets!");

            } else {
                // Download (GET)
                const res = await fetch(GOOGLE_SCRIPT_URL);
                const cloudData = await res.json();
                
                if (cloudData && typeof cloudData === 'object') {
                    if(confirm("確定用雲端資料覆蓋本機資料嗎？")) {
                        state = { ...state, ...cloudData }; // Merge/Overwrite
                        saveData();
                        location.reload();
                    }
                } else {
                    throw new Error("Invalid Data");
                }
                status.innerText = "同步完成";
            }

        } catch (e) {
            console.error(e);
            status.innerText = "連線失敗: " + e.message;
            alert("同步失敗，請檢查網路或 API 網址");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
    
    // Manual Import/Export
    function exportData() { navigator.clipboard.writeText(JSON.stringify(state)); alert("代碼已複製！請傳給朋友"); }
    function openImportModal() { document.getElementById('import-modal').classList.add('open'); }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    function confirmImport() {
        const v = document.getElementById('import-area').value;
        if(v) { 
            try { 
                state = JSON.parse(v);
                saveData(); location.reload(); 
            } catch { alert("格式錯誤"); }
        }
    }
    function hardReset() { if(confirm("確定刪除所有資料?")) { localStorage.removeItem('bkk_2025_v4'); location.reload(); }}

</script>
</body>
</html>
