<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 曼谷聖誕跨年 - 泰廢了</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-bg': '#F9F8F4',
                        'jp-text': '#4A4A4A',
                        'jp-accent': '#C6A568', // 金色
                        'jp-blue': '#6B8EAD',
                        'jp-green': '#8DA399',
                        'jp-red': '#D67D7D',
                    },
                    fontFamily: {
                        sans: ['"Zen Kaku Gothic New"', '"Noto Sans TC"', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px rgba(0, 0, 0, 0.03)',
                        'gold': '0 4px 15px rgba(198, 165, 104, 0.15)',
                    }
                }
            }
        }
    </script>
   
    <style>
        body { background-color: #F0F0F0; font-family: 'Zen Kaku Gothic New', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        .app-container { background-color: #F9F8F4; max-width: 430px; margin: 0 auto; min-height: 100vh; padding-bottom: 100px; overflow-x: hidden; position: relative; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Timeline */
        .timeline-item { position: relative; padding-left: 36px; padding-bottom: 24px; border-left: 2px solid #E5E7EB; margin-left: 10px; }
        .timeline-item:last-child { border-left: 2px solid transparent; }
        .timeline-dot { position: absolute; left: -7px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: #C6A568; border: 2px solid #F9F8F4; z-index: 10; }
        .timeline-time { font-size: 11px; font-weight: bold; color: #6B8EAD; margin-bottom: 4px; display: block; }

        /* Drag Handle */
        .drag-handle { position: absolute; left: -36px; top: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: #d1d5db; cursor: grab; touch-action: none; }
        .drag-handle:active { color: #C6A568; cursor: grabbing; }

        /* Buttons */
        .cat-btn.active { border: 1px solid #C6A568; background-color: #FFFCF5; color: #C6A568; }
        .payer-btn.active { background-color: #FFF9E6; border: 1px solid #C6A568; color: #C6A568; font-weight: bold; }
        .split-btn.active { background-color: #4A4A4A; color: white; }
        .nav-btn.active { color: #C6A568; }
        .nav-btn.active i { transform: scale(1.1); transition: 0.2s; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        
        /* Edit Buttons */
        .edit-spot-btn { opacity: 0.3; transition: 0.2s; }
        .timeline-item:hover .edit-spot-btn { opacity: 1; }

        /* Sortable Ghost */
        .sortable-ghost { opacity: 0.4; background: #FFF9E6; }
    </style>
</head>
<body>

<div class="app-container">
    
    <header class="sticky top-0 z-50 bg-[#F9F8F4]/95 backdrop-blur-sm px-5 py-4 flex justify-between items-end border-b border-gray-100">
        <div>
            <p class="text-[10px] text-gray-400 tracking-widest mb-1">DEC 23 - DEC 28</p>
            <h1 class="text-xl font-bold text-jp-text tracking-wide leading-tight">2025 曼谷聖誕跨年<br><span class="text-jp-accent text-lg">- 泰廢了 -</span></h1>
        </div>
        <div class="text-center">
             <span class="block text-[10px] text-gray-400">曼谷</span>
             <span class="text-sm font-medium transition-all duration-300" id="header-status">
                 <span class="text-gray-400 text-xs" id="header-weather">28°C</span>
             </span>
        </div>
    </header>

    <div id="tab-home" class="section active px-5 py-4">
        
        <div class="bg-white rounded-[32px] p-6 shadow-soft mb-8 relative overflow-hidden">
            <div class="absolute -top-6 -right-6 w-20 h-20 bg-[#F9F8F4] rounded-full z-0"></div>
            <h2 class="text-lg font-bold text-jp-text mb-5 relative z-10">Dashboard</h2>
            
            <div class="flex gap-4 mb-5 relative z-10">
                <div class="flex-1 bg-gray-50/50 rounded-2xl p-3 flex flex-col justify-between h-24">
                    <span class="text-[10px] text-gray-400">匯率 (TWD/THB)</span>
                    <span class="text-2xl font-bold text-jp-text mt-1" id="dash-rate">loading...</span>
                    <span class="text-[10px] text-green-600 mt-auto">即時匯率更新</span>
                </div>
                <div class="flex-1 bg-gray-50/50 rounded-2xl p-3 flex flex-col justify-between h-24">
                    <span class="text-[10px] text-gray-400">公費錢包</span>
                    <span class="text-xl font-bold text-jp-text mt-1 truncate" id="home-fund-display">฿ 0</span>
                    <span class="text-[10px] text-gray-400 mt-auto">剩餘預算</span>
                </div>
            </div>

            <div class="bg-gray-100 rounded-xl px-4 py-3 flex items-center justify-between relative z-10">
                <div class="flex-1 mr-2">
                    <p class="text-[10px] text-gray-400 mb-1">求生泰語</p>
                    <input type="text" id="thai-input" placeholder="Mai Sai Pak Chi (不要香菜)" class="w-full bg-transparent text-sm text-jp-text font-medium outline-none placeholder-gray-400">
                </div>
                <button onclick="translateThai()" class="text-gray-400 hover:text-jp-accent active:scale-95 transition">
                    <i class="fas fa-volume-up text-lg"></i>
                </button>
            </div>
        </div>

        <h3 class="text-sm font-bold text-gray-400 mb-3 ml-1 uppercase tracking-wider">QUICK ACCESS</h3>
        <div class="grid grid-cols-2 gap-3 mb-20">
             <button onclick="switchTab('tab-checklist')" class="bg-white p-4 rounded-xl shadow-soft text-left flex flex-col justify-between h-28 active:scale-95 transition">
                <i class="fas fa-tasks text-jp-accent text-xl"></i>
                <div>
                    <span class="text-sm font-bold block text-jp-text mt-2">行李清單</span>
                    <span class="text-xs text-gray-400" id="home-check-progress">完成度 0%</span>
                </div>
            </button>

            <button onclick="switchTab('tab-account')" class="bg-white p-4 rounded-xl shadow-soft text-left flex flex-col justify-between h-28 border border-jp-accent/20 active:scale-95 transition relative">
                 <div class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                <i class="fas fa-calculator text-jp-red text-xl"></i>
                <div>
                    <span class="text-sm font-bold block text-jp-text mt-2">智慧記帳</span>
                    <span class="text-xs text-gray-400" id="home-account-status">待結算...</span>
                </div>
            </button>

            <button onclick="switchTab('tab-itinerary')" class="bg-white p-4 rounded-xl shadow-soft text-left flex flex-col justify-between h-24 relative overflow-hidden group active:scale-95 transition col-span-2">
                <div class="absolute top-0 right-0 w-12 h-12 bg-jp-blue/10 rounded-full -mr-4 -mt-4"></div>
                <div class="flex items-center gap-3">
                    <i class="fas fa-map-marked-alt text-jp-blue text-xl relative z-10"></i>
                    <div>
                        <span class="text-sm font-bold block text-jp-text">行程規劃</span>
                        <span class="text-xs text-gray-400 font-sans" id="current-date-display">Dec 23</span>
                    </div>
                </div>
            </button>
        </div>
    </div>

    <div id="tab-itinerary" class="section pb-24">
        <div class="sticky top-[72px] z-40 bg-[#F9F8F4] px-5 py-2 mb-2 shadow-sm flex justify-between items-center">
            <div class="flex overflow-x-auto hide-scrollbar gap-3 pb-2 flex-1" id="day-tabs"></div>
            <button onclick="openEditSpot()" class="ml-2 w-8 h-8 rounded-full bg-jp-text text-white flex items-center justify-center shadow-md flex-shrink-0"><i class="fas fa-plus text-xs"></i></button>
        </div>
        
        <p class="text-[10px] text-gray-400 text-center mb-2"><i class="fas fa-bars mr-1"></i>按住左側把手可拖曳排序</p>
        <div id="itinerary-content" class="px-5 space-y-4 min-h-[50vh]">
            </div>

        <div class="px-5 mt-8 mb-4">
             <h3 class="text-sm font-bold text-gray-400 mb-2 uppercase">住宿資訊</h3>
             <div class="bg-white rounded-xl p-3 shadow-sm border-l-4 border-jp-blue mb-2">
                 <p class="text-xs font-bold text-jp-blue">12/23 - 12/25 (唐人街)</p>
                 <p class="text-sm font-bold text-jp-text">B2 唐人街耀華力尊尚飯店</p>
                 <a href="https://maps.app.goo.gl/ZjNM4vwDCNQdAq637?g_st=ipc" target="_blank" class="text-[10px] text-gray-400 underline"><i class="fas fa-map-marker-alt"></i> 查看地圖</a>
             </div>
             <div class="bg-white rounded-xl p-3 shadow-sm border-l-4 border-jp-accent">
                 <p class="text-xs font-bold text-jp-accent">12/25 - 12/27 (通羅)</p>
                 <p class="text-sm font-bold text-jp-text">曼谷茉莉花59號飯店</p>
                 <a href="https://maps.app.goo.gl/DmVbJdwrbkwQ7p8K6?g_st=ipc" target="_blank" class="text-[10px] text-gray-400 underline"><i class="fas fa-map-marker-alt"></i> 查看地圖</a>
             </div>
        </div>
    </div>

    <div id="tab-account" class="section px-4 py-4 pb-24">
        <div class="bg-white rounded-2xl shadow-gold p-5 border border-gray-50 relative">
            <div class="absolute top-4 right-4 text-right">
                <p class="text-[10px] text-gray-400">公費包餘額 (THB)</p>
                <p class="text-xl font-bold text-jp-accent" id="acc-fund-display">฿ 0</p>
            </div>
            <h2 class="text-lg font-bold text-jp-text mb-4">新增記帳</h2>
            
            <div class="flex justify-between gap-2 overflow-x-auto hide-scrollbar mb-4" id="cat-container"></div>
            
            <div class="flex gap-2 mb-4">
                 <div class="flex bg-gray-50 rounded-lg p-1 h-14 items-center">
                    <button onclick="setCurrency('TWD')" id="cur-twd" class="px-3 py-2 text-xs rounded text-gray-400 font-bold h-full">TWD</button>
                    <button onclick="setCurrency('THB')" id="cur-thb" class="px-3 py-2 text-xs rounded bg-white shadow-sm text-jp-text font-bold h-full">THB</button>
                </div>
                <div class="flex-1 bg-gray-50 rounded-xl px-4 flex flex-col justify-center relative">
                    <span class="text-[10px] text-gray-400 absolute top-2 right-4">金額</span>
                    <input type="number" id="amt-input" placeholder="0" class="w-full text-right text-3xl font-bold text-jp-text bg-transparent outline-none p-0">
                </div>
            </div>

            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-xs text-gray-400">付款人</p>
                    <button onclick="editUsers()" class="text-[10px] text-blue-400 underline">編輯名單</button>
                </div>
                <div class="flex flex-wrap gap-2" id="payer-container"></div>
            </div>
            <div class="mb-4">
                <p class="text-xs text-gray-400 mb-2">分攤模式</p>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setSplit('shared')" id="split-shared" class="split-btn active py-2 rounded-lg text-xs border border-gray-200">共同分攤 (扣公費/記帳)</button>
                    <button onclick="setSplit('deposit')" id="split-deposit" class="split-btn py-2 rounded-lg text-xs border border-gray-200 text-gray-400">公費入金 (存錢)</button>
                    <button onclick="setSplit('own')" id="split-own" class="split-btn py-2 rounded-lg text-xs border border-gray-200 text-gray-400">個人自付</button>
                    <button onclick="setSplit('advance')" id="split-advance" class="split-btn py-2 rounded-lg text-xs border border-gray-200 text-gray-400">幫人代墊</button>
                </div>
            </div>
            <div class="flex gap-2 mb-4">
                <button class="w-10 h-10 rounded-full border border-gray-200 flex items-center justify-center text-gray-400"><i class="fas fa-camera"></i></button>
                <input type="text" id="note-input" placeholder="備註 (如: 7-11)" class="flex-1 bg-gray-50 rounded-lg px-3 text-sm outline-none">
            </div>
            <button onclick="submitTx()" class="w-full bg-jp-text text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">新增紀錄</button>
        </div>
        <div class="mt-6">
            <div class="flex justify-between items-center mb-2 px-1">
                 <h3 class="text-sm font-bold text-gray-500">近期紀錄</h3>
                <button onclick="clearTx()" class="text-xs text-red-300">清空</button>
            </div>
            <div id="tx-history" class="space-y-2 pb-10"></div>
        </div>
    </div>
    
    <div id="tab-checklist" class="section px-5 py-4 pb-24">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">行李清單</h2>
            <div class="flex gap-2">
                <button onclick="addChecklistCategory()" class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center"><i class="fas fa-folder-plus text-xs"></i></button>
                <button onclick="addChecklistItem()" class="w-8 h-8 rounded-full bg-jp-accent text-white flex items-center justify-center shadow-md"><i class="fas fa-plus text-xs"></i></button>
            </div>
        </div>
         <div id="checklist-container"></div>
    </div>

    <div id="tab-settings" class="section px-5 py-4 pb-24">
        <h2 class="text-xl font-bold mb-6">資料同步 & 設定</h2>
        
        <div class="bg-white rounded-2xl shadow-soft p-5 mb-6 border border-jp-green/30 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-16 h-16 bg-jp-green/10 rounded-full -mr-6 -mt-6"></div>
            <h3 class="font-bold text-jp-text mb-2"><i class="fab fa-google-drive text-jp-green mr-2"></i>雲端資料庫 (Google Sheets)</h3>
            <p class="text-xs text-gray-500 mb-4 leading-relaxed">
               同步至 Google 試算表。<br>
               <span class="text-[10px] text-gray-400">需連網。點擊下載會覆蓋本機資料。</span>
            </p>
            <div class="flex gap-3">
                 <button onclick="syncToCloud('upload')" id="btn-upload" class="flex-1 bg-jp-text text-white py-3 rounded-lg text-sm shadow hover:opacity-90 active:scale-95 transition flex items-center justify-center gap-2">
                    <i class="fas fa-cloud-upload-alt"></i> 上傳備份
                </button>
                <button onclick="syncToCloud('download')" id="btn-download" class="flex-1 bg-white border border-jp-text text-jp-text py-3 rounded-lg text-sm shadow hover:bg-gray-50 active:scale-95 transition flex items-center justify-center gap-2">
                    <i class="fas fa-cloud-download-alt"></i> 下載覆蓋
                </button>
            </div>
            <p id="sync-status" class="text-[10px] text-center mt-2 text-gray-400 h-4"></p>
        </div>

        <div class="bg-white rounded-2xl shadow-soft p-5 mb-6 border border-jp-blue/20">
            <h3 class="font-bold text-jp-blue mb-2"><i class="fas fa-qrcode mr-2"></i>快速轉移 (無網路用)</h3>
            <div class="flex gap-3">
                 <button onclick="exportData()" class="flex-1 bg-jp-blue text-white py-3 rounded-lg text-sm shadow hover:opacity-90"><i class="fas fa-copy mr-1"></i> 複製代碼</button>
                <button onclick="openImportModal()" class="flex-1 bg-gray-600 text-white py-3 rounded-lg text-sm shadow hover:opacity-90"><i class="fas fa-paste mr-1"></i> 貼上匯入</button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-soft p-5">
            <h3 class="font-bold text-jp-text mb-3">緊急聯絡電話</h3>
            <div class="space-y-2">
                <div class="flex justify-between text-sm border-b border-gray-50 pb-2"><span>觀光警察</span><span class="font-bold text-red-500">1155</span></div>
                <div class="flex justify-between text-sm border-b border-gray-50 pb-2"><span>救護車</span><span class="font-bold text-red-500">1669</span></div>
                <div class="flex justify-between text-sm"><span>駐泰代表處</span><span class="font-bold text-blue-500">+66-81-666-4006</span></div>
            </div>
        </div>
        <div class="mt-8 text-center">
             <button onclick="hardReset()" class="text-xs text-red-400 underline p-2">重置所有 App 資料 (慎用)</button>
        </div>
    </div>
    
    <div class="fixed right-5 bottom-24 z-50 flex flex-col gap-3">
        <button onclick="syncToCloud('download')" class="w-10 h-10 rounded-full bg-white shadow-lg border border-gray-100 flex items-center justify-center text-gray-500 active:scale-90 transition hover:text-jp-blue">
            <i class="fas fa-cloud-download-alt"></i>
        </button>
        <button onclick="syncToCloud('upload')" class="w-10 h-10 rounded-full bg-jp-text shadow-lg border border-jp-text flex items-center justify-center text-white active:scale-90 transition hover:bg-gray-700">
            <i class="fas fa-cloud-upload-alt"></i>
        </button>
    </div>

    <nav class="fixed bottom-6 left-5 right-5 h-16 bg-white/95 backdrop-blur rounded-2xl flex justify-around items-center shadow-gold z-50 border border-gray-100">
        <button onclick="switchTab('tab-home')" class="nav-btn active flex flex-col items-center gap-1 text-gray-400" data-target="tab-home">
            <i class="fas fa-home text-lg"></i><span class="text-[10px]">首頁</span>
        </button>
        <button onclick="switchTab('tab-itinerary')" class="nav-btn flex flex-col items-center gap-1 text-gray-400" data-target="tab-itinerary">
            <i class="fas fa-map-marked-alt text-lg"></i><span class="text-[10px]">行程</span>
        </button>
        <div class="relative -top-6">
            <button onclick="switchTab('tab-account')" class="w-14 h-14 bg-jp-text rounded-full shadow-lg flex items-center justify-center text-white text-xl transform hover:scale-105 transition active:scale-95 border-4 border-[#F9F8F4]">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        <button onclick="switchTab('tab-checklist')" class="nav-btn flex flex-col items-center gap-1 text-gray-400" data-target="tab-checklist">
            <i class="fas fa-check-circle text-lg"></i><span class="text-[10px]">清單</span>
        </button>
        <button onclick="switchTab('tab-settings')" class="nav-btn flex flex-col items-center gap-1 text-gray-400" data-target="tab-settings">
            <i class="fas fa-cog text-lg"></i><span class="text-[10px]">我的</span>
        </button>
    </nav>

    <div id="import-modal" class="modal-overlay"><div class="bg-white w-4/5 rounded-2xl p-5 shadow-2xl"><h3 class="font-bold text-lg mb-2">貼上代碼</h3><textarea id="import-area" class="w-full h-32 bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs mb-4"></textarea><div class="flex gap-2"><button onclick="closeModal('import-modal')" class="flex-1 py-2 rounded-lg border border-gray-200 text-sm">取消</button><button onclick="confirmImport()" class="flex-1 py-2 rounded-lg bg-jp-text text-white text-sm">確定</button></div></div></div>
    <div id="advance-modal" class="modal-overlay"><div class="bg-white w-4/5 rounded-2xl p-5 shadow-2xl"><h3 class="font-bold text-lg mb-2">幫誰代墊?</h3><div id="advance-list" class="space-y-2 mb-4"></div><div class="flex gap-2"><button onclick="closeModal('advance-modal')" class="flex-1 py-2 rounded-lg border border-gray-200 text-sm">取消</button><button onclick="confirmAdvance()" class="flex-1 py-2 rounded-lg bg-jp-text text-white text-sm">確定</button></div></div></div>

    <div id="itinerary-modal" class="modal-overlay">
        <div class="bg-white w-[90%] rounded-2xl p-5 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4 text-jp-text" id="spot-modal-title">編輯景點</h3>
            <input type="hidden" id="spot-index">
            <div class="space-y-3">
                <div><label class="text-xs text-gray-400 block mb-1">時間</label><input type="text" id="spot-time" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm"></div>
                <div><label class="text-xs text-gray-400 block mb-1">名稱</label><input type="text" id="spot-name" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm font-bold"></div>
                <div><label class="text-xs text-gray-400 block mb-1">描述</label><input type="text" id="spot-desc" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm"></div>
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-xs text-gray-400 block mb-1">Google Map 網址</label><input type="text" id="spot-link" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-xs" placeholder="https://..."></div>
                    <div><label class="text-xs text-gray-400 block mb-1">攻略關鍵字</label><input type="text" id="spot-keyword" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-xs" placeholder="搜尋用"></div>
                </div>
                 <div><label class="text-xs text-gray-400 block mb-1">Icon (FontAwesome)</label><input type="text" id="spot-icon" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-xs" value="fa-map-marker-alt"></div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="deleteSpot()" id="btn-delete-spot" class="px-4 py-2 rounded-lg bg-red-50 text-red-400 text-sm"><i class="fas fa-trash"></i></button>
                <button onclick="closeModal('itinerary-modal')" class="flex-1 py-2 rounded-lg border border-gray-200 text-sm">取消</button>
                <button onclick="saveSpot()" class="flex-1 py-2 rounded-lg bg-jp-text text-white text-sm">儲存</button>
            </div>
        </div>
    </div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxYeyHua8VRjHu3dHbP3glwWcFf5zClFG_drBD9gR_j9MZpcGf6uajQUzmOw_Au_o0o/exec';
    
    // --- UPDATED DATA ---
    const DEFAULT_ITINERARY = [
        {
            "day": 1, "date": "12/23 (二)", "desc": "抵達曼谷",
            "spots": [
                { "time": "18:00", "name": "高雄機場出發", "desc": "泰國亞航 FD235 ✈️ (21:30 抵達廊曼)", "icon": "fa-plane", "color": "text-blue-500" },
                { "time": "22:30", "name": "機場包車接機", "desc": "前往 B2 飯店 (車程約30分)", "icon": "fa-car", "color": "text-green-600", "highlight": true },
                { "time": "Late", "name": "唐人街宵夜", "desc": "Check-in 後覓食", "icon": "fa-utensils", "color": "text-orange-500", "keyword": "曼谷唐人街美食" },
                { "time": "Sleep", "name": "B2 唐人街飯店", "desc": "入住休息", "link": "https://maps.app.goo.gl/ZjNM4vwDCNQdAq637?g_st=ipc", "keyword": "", "icon": "fa-bed", "color": "text-gray-500" }
            ]
        },
        {
            "day": 2, "date": "12/24 (三)", "desc": "舊城古蹟巡禮",
            "spots": [
                { "time": "09:30", "name": "石龍軍路", "desc": "文青散策 / 美食 (豬腳飯、仁和園)", "link": "", "keyword": "石龍軍路美食", "icon": "fa-walking", "color": "text-gray-500" },
                { "time": "11:00", "name": "臥佛寺", "desc": "必拍古蹟", "link": "", "keyword": "鄭王廟 拍照", "icon": "fa-gopuram", "color": "text-gray-500" },
                { "time": "13:30", "name": "鄭王廟", "desc": "拍照參觀", "link": "https://maps.app.goo.gl/4t2JkPEY1yKKBtoq5?g_st=ipc", "keyword": "鄭王廟", "icon": "fa-store", "color": "text-gray-500" },
                { "time": "14:30", "name": "王朗市場", "desc": "拍照參觀", "link": "https://maps.app.goo.gl/Q43nUqg7KE9dRj8Z9?g_st=ipc", "keyword": "王朗市場", "icon": "fa-map-marker-alt", "color": "text-gray-500" },
                { "time": "19:00", "name": "昭披耶河晚餐", "desc": "River City 郵輪", "icon": "fa-ship", "color": "text-blue-600", "keyword": "昭披耶河遊船推薦" }
            ]
        },
        {
            "day": 3, "date": "12/25 (四)", "desc": "通羅時尚漫遊",
            "spots": [
                { "time": "09:00", "name": "傳統早餐", "desc": "益生甫記  or 安樂園", "link": "https://maps.app.goo.gl/JmfSPvJffbXh7CeS7?g_st=ipc", "keyword": "曼谷 安樂園", "icon": "fa-coffee", "color": "text-gray-500" },
                { "time": "10:30", "name": "嵩越路", "desc": "文青街拍", "link": "https://maps.app.goo.gl/eM2DRoHF2P22VCAv8?g_st=ipc", "keyword": "嵩越路", "icon": "fa-camera", "color": "text-gray-500" },
                { "time": "12:00", "name": "換飯店", "desc": "前往 Jasmine 59 Hotel (通羅)", "link": "https://maps.app.goo.gl/DmVbJdwrbkwQ7p8K6?g_st=ipc", "keyword": "", "icon": "fa-suitcase", "color": "text-gray-500" },
                { "time": "14:00", "name": "石龍軍路(上)", "desc": "32Bar", "icon": "fa-glass-cheers", "color": "text-purple-500" },
                { "time": "Eve", "name": "百貨 / 考山路", "desc": "Iconsiam / Central World / 考山路", "icon": "fa-shopping-bag", "color": "text-jp-text" }
            ]
        },
        {
            "day": 4, "date": "12/26 (五)", "desc": "水上市場一日遊",
            "spots": [
                { "time": "08:00", "name": "包車出發", "desc": "飯店大廳集合 (準時!)", "icon": "fa-car", "color": "text-red-500", "highlight": true },
                { "time": "10:00", "name": "美功鐵道市場", "desc": "看火車進站", "link": "https://maps.app.goo.gl/4f6eR12QvvsLoArb7?g_st=ipc", "keyword": "美功鐵道市場", "icon": "fa-train", "color": "text-gray-500" },
                { "time": "12:00", "name": "丹嫩莎水上市場", "desc": "手搖船體驗", "link": "https://maps.app.goo.gl/n4JDTNY2q7Bqkrxw8?g_st=ipc", "keyword": "樹中廟", "icon": "fa-water", "color": "text-gray-500" },
                { "time": "14:00", "name": "樹中廟", "desc": "靈驗古廟", "link": "https://maps.app.goo.gl/z8xrK7NTUiyW4P6n8?g_st=ipc", "keyword": "樹中廟", "icon": "fa-vihara", "color": "text-gray-500" },
                { "time": "16:00", "name": "返回曼谷", "desc": "回飯店或按摩", "icon": "fa-home", "color": "text-gray-500" }
            ]
        },
        {
            "day": 5, "date": "12/27 (六)", "desc": "返台 / 自由",
            "spots": [
                { "time": "10:00", "name": "恰圖恰市集", "desc": "最後採買 / 按摩", "link": "https://maps.app.goo.gl/T9QymcxerpaBbFGc7?g_st=ipc", "keyword": "恰圖恰市集", "icon": "fa-smile", "color": "text-gray-500" },
                { "time": "Flight", "name": "前往機場", "desc": "預備返台", "icon": "fa-plane-departure", "color": "text-blue-500" }
            ]
        }
    ];

    let state = {
        users: ["冠仔","小芳","玠宇","婕茹","芝伶","公費包"],
        fundBalance: 0,
        currency: 'THB',
        transactions: [],
        checklist: [{"title":"證件","items":[{"name":"護照","checked":true},{"name":"eSIM","checked":false},{"name":"保險單","checked":false}]}],
        itinerary: DEFAULT_ITINERARY, 
        currentDay: 0
    };
    
    let sortableInstance = null;

    document.addEventListener('DOMContentLoaded', () => {
        try {
            loadData();
            updateDate();
            fetchWeather();
            fetchExchangeRate();
            renderDayTabs();
            renderItinerary();
            renderAccCats();
            renderPayers();
            updateFundDisplay();
            renderHistory();
            renderChecklist();
            
            // Try Auto Sync
            autoSync();

            console.log("App initialized successfully");
        } catch (e) {
            alert("App Init Error: " + e.message);
        }
    });

    // --- LOGIC ---
    function updateDate() { document.getElementById('current-date-display').innerText = new Date().toLocaleDateString('en-US', {month:'short', day:'numeric'}); }
    
    async function fetchWeather() {
        try {
            const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=13.75&longitude=100.50&current_weather=true');
            const data = await res.json();
            document.getElementById('header-weather').innerHTML = `${Math.round(data.current_weather.temperature)}°C <i class="fas fa-sun text-yellow-400"></i>`;
        } catch { document.getElementById('header-weather').innerText = "28°C"; }
    }

    async function fetchExchangeRate() {
        try {
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/THB');
            const data = await res.json();
            const rate = data.rates.TWD; 
            document.getElementById('dash-rate').innerText = rate.toFixed(2);
        } catch {
            document.getElementById('dash-rate').innerText = "0.92";
        }
    }

    function translateThai() {
        const txt = document.getElementById('thai-input').value;
        if(txt) window.open(`https://translate.google.com/?sl=zh-TW&tl=th&text=${encodeURIComponent(txt)}&op=translate`, '_blank');
    }

    // Itinerary & Sortable
    function renderDayTabs() {
        document.getElementById('day-tabs').innerHTML = state.itinerary.map((d, i) => `
            <button onclick="setDay(${i})" class="flex-shrink-0 px-4 py-2 rounded-xl border ${state.currentDay===i ? 'bg-jp-text text-white border-jp-text shadow-md' : 'bg-white text-gray-400 border-gray-100'}">
                <span class="block text-xs font-bold">Day ${d.day}</span>
                <span class="text-[10px] whitespace-nowrap">${d.date.split(' ')[0]}</span>
            </button>
        `).join('');
    }
    function setDay(i) { state.currentDay = i; renderDayTabs(); renderItinerary(); }
    
    function renderItinerary() {
        const d = state.itinerary[state.currentDay];
        const c = document.getElementById('itinerary-content');
        
        if(!d.spots || d.spots.length === 0) { c.innerHTML = `<div class="text-center py-10 text-gray-400 text-sm">點擊 + 新增行程</div>`; return; }
        
        c.innerHTML = d.spots.map((s, idx) => `
            <div class="timeline-item group" data-id="${idx}">
                <div class="drag-handle"><i class="fas fa-bars"></i></div>
                <div class="timeline-dot" style="${s.highlight ? 'background:#ef4444; border-color:#fee2e2;' : ''}"></div>
                <span class="timeline-time ${s.highlight ? 'text-red-500' : ''}">${s.time}</span>
                <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-50 relative">
                    <button onclick="openEditSpot(${idx})" class="absolute top-2 right-2 text-gray-300 hover:text-jp-accent p-1 edit-spot-btn"><i class="fas fa-pen text-xs"></i></button>
                    <div class="flex justify-between items-start pr-6">
                        <p class="text-sm font-bold text-jp-text"><i class="fas ${s.icon} ${s.color || 'text-gray-500'} mr-1"></i> ${s.name}</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 mb-2">${s.desc}</p>
                    <div class="flex gap-2 mt-2 border-t border-gray-50 pt-2">
                        ${s.link ? `<a href="${s.link}" target="_blank" class="text-[10px] bg-blue-50 text-blue-500 px-2 py-1 rounded hover:bg-blue-100"><i class="fas fa-map-marker-alt"></i> 地圖</a>` : ''}
                        ${s.keyword ? `<a href="https://www.google.com/search?q=${encodeURIComponent(s.keyword)}" target="_blank" class="text-[10px] bg-orange-50 text-orange-500 px-2 py-1 rounded hover:bg-orange-100"><i class="fab fa-google"></i> 搜攻略</a>` : ''}
                    </div>
                </div>
            </div>
        `).join('');

        // Init Sortable
        if(sortableInstance) sortableInstance.destroy();
        sortableInstance = new Sortable(c, {
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            animation: 150,
            onEnd: function(evt) {
                const oldIndex = evt.oldIndex;
                const newIndex = evt.newIndex;
                if(oldIndex === newIndex) return;

                // Update Data
                const spots = state.itinerary[state.currentDay].spots;
                const [movedItem] = spots.splice(oldIndex, 1);
                spots.splice(newIndex, 0, movedItem);
                
                // Save and Re-render (to fix CSS timeline borders)
                saveData();
                renderItinerary();
            }
        });
    }

    // Edit Modal Logic
    let currentEditIndex = -1;
    function openEditSpot(index = -1) {
        currentEditIndex = index;
        document.getElementById('itinerary-modal').classList.add('open');
        const title = document.getElementById('spot-modal-title');
        const btnDel = document.getElementById('btn-delete-spot');
        const fields = ['time', 'name', 'desc', 'link', 'keyword', 'icon'];
        
        if (index === -1) {
            title.innerText = "新增行程"; btnDel.style.display = 'none';
            fields.forEach(f => document.getElementById('spot-'+f).value = (f==='icon'?'fa-map-marker-alt':''));
        } else {
            title.innerText = "修改行程"; btnDel.style.display = 'block';
            const s = state.itinerary[state.currentDay].spots[index];
            fields.forEach(f => document.getElementById('spot-'+f).value = s[f] || (f==='icon'?'fa-map-marker-alt':''));
        }
    }
    function saveSpot() {
        const s = {
            time: document.getElementById('spot-time').value,
            name: document.getElementById('spot-name').value,
            desc: document.getElementById('spot-desc').value,
            link: document.getElementById('spot-link').value,
            keyword: document.getElementById('spot-keyword').value,
            icon: document.getElementById('spot-icon').value,
            color: 'text-gray-500'
        };
        if (!s.name) return alert("請輸入名稱");
        if (!state.itinerary[state.currentDay].spots) state.itinerary[state.currentDay].spots = [];
        
        if (currentEditIndex === -1) { state.itinerary[state.currentDay].spots.push(s); }
        else { state.itinerary[state.currentDay].spots[currentEditIndex] = s; }
        
        // Removed Auto-Sort by time to allow manual sorting
        // state.itinerary[state.currentDay].spots.sort((a,b)=>a.time.localeCompare(b.time)); 
        
        saveData(); renderItinerary(); closeModal('itinerary-modal');
    }
    function deleteSpot() { if(confirm("刪除?")) { state.itinerary[state.currentDay].spots.splice(currentEditIndex, 1); saveData(); renderItinerary(); closeModal('itinerary-modal'); } }

    // Accounting
    let acc = { cat: '餐飲', payer: '公費包', split: 'shared', cur: 'THB' };
    function renderAccCats() {
        const cats = [{n:'餐飲',i:'fa-utensils'}, {n:'交通',i:'fa-car'}, {n:'購物',i:'fa-shopping-bag'}, {n:'住宿',i:'fa-bed'}, {n:'其他',i:'fa-ellipsis-h'}];
        document.getElementById('cat-container').innerHTML = cats.map((c, i) => `<button onclick="setCat('${c.n}', this)" class="cat-btn ${i===0?'active':''} flex-shrink-0 w-16 h-16 rounded-xl flex flex-col items-center justify-center bg-white border border-gray-100"><i class="fas ${c.i} text-lg mb-1"></i><span class="text-xs">${c.n}</span></button>`).join('');
    }
    function setCat(n, el) { acc.cat = n; document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); }
    function renderPayers() { document.getElementById('payer-container').innerHTML = state.users.map(u => `<button onclick="setPayer('${u}', this)" class="payer-btn ${u==='公費包'?'active':''} px-3 py-1 bg-gray-50 text-gray-400 rounded-lg text-xs border border-transparent">${u}</button>`).join(''); }
    function setPayer(u, el) { acc.payer = u; document.querySelectorAll('.payer-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); }
    function setCurrency(c) { acc.cur = c; document.getElementById('cur-twd').className = c==='TWD' ? "px-3 py-2 text-xs rounded bg-white shadow-sm text-jp-text font-bold h-full" : "px-3 py-2 text-xs rounded text-gray-400 font-bold h-full"; document.getElementById('cur-thb').className = c==='THB' ? "px-3 py-2 text-xs rounded bg-white shadow-sm text-jp-text font-bold h-full" : "px-3 py-2 text-xs rounded text-gray-400 font-bold h-full"; }
    function setSplit(t) { acc.split = t; document.querySelectorAll('.split-btn').forEach(b => { b.classList.remove('active'); b.classList.add('text-gray-400'); }); document.getElementById(`split-${t}`).classList.add('active'); document.getElementById(`split-${t}`).classList.remove('text-gray-400'); }

    function submitTx() {
        const amt = parseFloat(document.getElementById('amt-input').value);
        if (!amt) return alert("請輸入金額");
        if (acc.split === 'advance') { document.getElementById('advance-modal').classList.add('open'); document.getElementById('advance-list').innerHTML = state.users.filter(u => u !== '公費包').map(u => `<label class="flex items-center gap-2 p-2 bg-gray-50 rounded"><input type="checkbox" value="${u}"> ${u}</label>`).join(''); return; }
        processTx(amt, document.getElementById('note-input').value, acc.payer, acc.split, acc.cat, acc.cur, []);
    }
    function confirmAdvance() {
        const checked = Array.from(document.querySelectorAll('#advance-list input:checked')).map(cb => cb.value);
        if(checked.length === 0) return alert("請選擇對象");
        processTx(parseFloat(document.getElementById('amt-input').value), document.getElementById('note-input').value, acc.payer, 'advance', acc.cat, acc.cur, checked);
        closeModal('advance-modal');
    }
    function processTx(amt, note, payer, split, cat, cur, targets) {
        if(split === 'deposit') state.fundBalance += amt; else if (payer === '公費包') state.fundBalance -= amt;
        state.transactions.unshift({ date: new Date().toLocaleString(), amt, note, payer, split, cat, cur, targets });
        saveData(); updateFundDisplay(); renderHistory();
        document.getElementById('amt-input').value = ''; document.getElementById('note-input').value = '';
        alert("已記錄");
    }
    function updateFundDisplay() { 
        const txt = `฿ ${state.fundBalance.toLocaleString()}`; 
        document.getElementById('acc-fund-display').innerText = txt; 
        document.getElementById('home-fund-display').innerText = txt;
        document.getElementById('home-account-status').innerText = `餘額: ${txt}`;
    }
    function renderHistory() { document.getElementById('tx-history').innerHTML = state.transactions.slice(0, 10).map(t => `<div class="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center border border-gray-50"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs text-gray-500">${t.payer[0]}</div><div><p class="text-sm font-bold text-jp-text">${t.note || t.cat}</p><p class="text-[10px] text-gray-400">${t.split==='deposit'?'入金':t.split==='advance'?`代墊(${t.targets.length})`:'支出'}</p></div></div><span class="font-bold ${t.split==='deposit'?'text-green-500':'text-jp-text'}">${t.split==='deposit'?'+':'-'} ${t.amt}</span></div>`).join(''); }
    function clearTx() { if(confirm("確定清空?")) { state.transactions=[]; state.fundBalance=0; saveData(); location.reload(); }}
    function editUsers() { const n = prompt("輸入新成員 (逗號分隔)", state.users.join(',')); if(n) { state.users = n.split(','); saveData(); renderPayers(); } }

    // Checklist
    function renderChecklist() {
        let total=0, checked=0;
        document.getElementById('checklist-container').innerHTML = state.checklist.map((g, gi) => `
            <div class="bg-white rounded-xl p-4 shadow-soft mb-3">
                <div class="flex justify-between mb-2"><input type="text" value="${g.title}" onchange="state.checklist[${gi}].title=this.value;saveData()" class="font-bold text-sm bg-transparent outline-none"><span class="text-xs text-gray-400">${g.items.filter(i=>i.checked).length}/${g.items.length}</span></div>
                <div class="w-full bg-gray-100 h-1 rounded-full mb-3"><div class="bg-jp-green h-1 rounded-full" style="width:${(g.items.filter(i=>i.checked).length/(g.items.length||1))*100}%"></div></div>
                <div class="space-y-2">${g.items.map((i, ii) => { total++; if(i.checked) checked++; return `<div class="flex items-center justify-between"><label class="flex items-center gap-2 text-sm text-gray-600"><input type="checkbox" ${i.checked?'checked':''} class="accent-jp-green" onchange="state.checklist[${gi}].items[${ii}].checked=!state.checklist[${gi}].items[${ii}].checked;saveData();renderChecklist()"><span class="${i.checked?'line-through text-gray-300':''}">${i.name}</span></label><button onclick="state.checklist[${gi}].items.splice(${ii},1);saveData();renderChecklist()" class="text-gray-200 text-xs"><i class="fas fa-times"></i></button></div>`; }).join('')}<button onclick="const n=prompt('項目');if(n){state.checklist[${gi}].items.push({name:n,checked:false});saveData();renderChecklist()}" class="text-xs text-jp-blue mt-2">+ 新增</button></div>
            </div>`).join('');
        document.getElementById('home-check-progress').innerText = `完成度 ${total===0?0:Math.round((checked/total)*100)}%`;
    }
    function addChecklistCategory() { state.checklist.push({title:'新分類', items:[]}); saveData(); renderChecklist(); }
    function addChecklistItem() { const n = prompt("項目名稱"); if(n) { state.checklist[0].items.push({name:n, checked:false}); saveData(); renderChecklist(); } }

    // System
    function switchTab(id) {
        document.querySelectorAll('.section').forEach(e => e.classList.remove('active')); document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('active'); b.style.color=''; });
        const btn = document.querySelector(`.nav-btn[data-target="${id}"]`); if(btn) btn.classList.add('active');
    }
    function saveData() { localStorage.setItem('bkk_2025_v8', JSON.stringify(state)); }
    function loadData() { const d = localStorage.getItem('bkk_2025_v8'); if(d) try { state = {...state, ...JSON.parse(d)}; } catch(e) {} }
    
    // Cloud Sync
    async function autoSync() {
        const headerStatus = document.getElementById('header-status');
        if(headerStatus) headerStatus.innerHTML = '<span class="text-gray-400 text-xs"><i class="fas fa-circle-notch fa-spin"></i> 同步中...</span>';
        
        // Add timestamp to disable caching
        try {
            const res = await fetch(GOOGLE_SCRIPT_URL + '?t=' + new Date().getTime());
            const cloudData = await res.json();
            
            if (cloudData && typeof cloudData === 'object') {
                state = { ...state, ...cloudData };
                saveData();
                renderAll();
                console.log("Auto-synced from cloud");
            }
        } catch (e) {
            console.log("Auto-sync failed (offline?)", e);
        } finally {
            fetchWeather();
        }
    }

    async function syncToCloud(action) {
        const btn = document.getElementById(action==='upload'?'btn-upload':'btn-download');
        let oldTxt = '';
        if(btn) { oldTxt = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true; }
        
        try {
            if (action === 'upload') {
                // Add timestamp to ensure data is unique
                state._lastUpdated = new Date().getTime(); 
                await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(state) });
                alert("已送出請求。請等待 3-5 秒後在另一台裝置按「下載」。");
            } else {
                const res = await fetch(GOOGLE_SCRIPT_URL + '?t=' + new Date().getTime()); // Anti-cache
                const data = await res.json();
                if (data && confirm("確定用雲端資料覆蓋本機?")) { 
                    state = {...state, ...data}; 
                    saveData(); 
                    renderAll(); 
                    alert("更新成功！");
                }
            }
        } catch (e) { alert("同步失敗: " + e.message + "\n請確認 Google Script 已正確部署。"); } 
        finally { 
            if(btn) { btn.innerHTML = oldTxt; btn.disabled = false; }
        }
    }
    
    function renderAll() {
        renderItinerary();
        renderAccCats();
        renderPayers();
        updateFundDisplay();
        renderHistory();
        renderChecklist();
    }

    function exportData() { navigator.clipboard.writeText(JSON.stringify(state)); alert("代碼已複製"); }
    function openImportModal() { document.getElementById('import-modal').classList.add('open'); }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    function confirmImport() { try { state = JSON.parse(document.getElementById('import-area').value); saveData(); location.reload(); } catch { alert("格式錯誤"); } }
    function hardReset() { if(confirm("刪除所有資料?")) { localStorage.removeItem('bkk_2025_v8'); location.reload(); } }
</script>
</body>
</html>
