<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 ÊõºË∞∑ËÅñË™ïË∑®Âπ¥ - Ê≥∞Âª¢‰∫Ü</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-bg': '#F9F8F4',
                        'jp-text': '#2D3748',
                        'jp-accent': '#C6A568',
                        'jp-blue': '#6B8EAD',
                        'jp-green': '#8DA399',
                        'mag-paper': '#FFFBF0',
                    },
                    fontFamily: {
                        sans: ['"Zen Kaku Gothic New"', 'sans-serif'],
                        serif: ['"Noto Serif TC"', 'serif'],
                    },
                    boxShadow: {
                        'card': '0 10px 30px -5px rgba(0, 0, 0, 0.05)',
                        'float': '0 20px 40px -10px rgba(0, 0, 0, 0.1)',
                    }
                }
            }
        }
    </script>
   
    <style>
        body { background-color: #F0F2F5; font-family: 'Zen Kaku Gothic New', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        .app-container { background-color: #F9F8F4; max-width: 430px; margin: 0 auto; min-height: 100vh; padding-bottom: 100px; overflow-x: hidden; position: relative; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Smooth Fade In */
        .section { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .section.active { display: block; opacity: 1; }

        /* Timeline & Cards */
        .timeline-item { position: relative; padding-left: 28px; padding-bottom: 24px; border-left: 2px solid #E2E8F0; margin-left: 16px; }
        .timeline-item:last-child { border-left: 2px solid transparent; }
        .timeline-dot { position: absolute; left: -7px; top: 16px; width: 12px; height: 12px; border-radius: 50%; background: #CBD5E0; border: 2px solid #F9F8F4; z-index: 10; transition: 0.3s; }
        .timeline-item.active .timeline-dot { background: #C6A568; transform: scale(1.2); }
        .timeline-time { font-size: 11px; font-weight: 700; color: #A0AEC0; margin-bottom: 4px; display: block; position: absolute; left: 28px; top: -2px; }

        /* Card Interactions */
        .spot-card { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s; }
        .spot-card:active { transform: scale(0.97); }

        /* Bottom Sheet Modal */
        .bottom-sheet { position: fixed; bottom: 0; left: 0; width: 100%; height: 100%; z-index: 9999; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; }
        .sheet-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); opacity: 0; transition: opacity 0.3s; pointer-events: auto; }
        .sheet-content { background: white; width: 100%; max-width: 430px; margin: 0 auto; border-radius: 24px 24px 0 0; padding: 24px; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); pointer-events: auto; max-height: 90vh; overflow-y: auto; position: relative; }
        
        .bottom-sheet.open .sheet-overlay { opacity: 1; }
        .bottom-sheet.open .sheet-content { transform: translateY(0); }

        /* Speak Modal */
        .speak-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1A202C; z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .speak-modal.open { display: flex; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* Weather Scroll */
        .weather-scroll { -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory; }
        .weather-item { scroll-snap-align: start; }

        .nav-btn.active { color: #C6A568; }
        .nav-btn.active i { transform: translateY(-2px); }
    </style>
</head>
<body>

<div class="app-container">
    
    <div class="fixed right-5 bottom-28 flex flex-col gap-3" style="z-index: 8000;">
        <button onclick="syncToCloud('download')" class="w-10 h-10 rounded-full bg-white shadow-lg border border-gray-100 flex items-center justify-center text-gray-400 active:scale-90 transition hover:text-jp-blue"><i class="fas fa-cloud-download-alt"></i></button>
        <button onclick="syncToCloud('upload')" class="w-10 h-10 rounded-full bg-jp-text shadow-lg border border-jp-text flex items-center justify-center text-white active:scale-90 transition hover:bg-gray-700"><i class="fas fa-cloud-upload-alt"></i></button>
    </div>

    <header class="sticky top-0 z-40 bg-[#F9F8F4]/95 backdrop-blur-sm px-5 py-4 flex justify-between items-end border-b border-gray-100/50">
        <div>
            <p class="text-[10px] text-gray-400 tracking-widest mb-1 font-bold">DEC 23 - DEC 28</p>
            <h1 class="text-xl font-bold text-jp-text tracking-wide leading-tight">Bangkok 2025<br><span class="text-jp-accent text-lg font-serif italic">- Ê≥∞Âª¢‰∫Ü -</span></h1>
        </div>
        <div class="text-center">
             <span class="block text-[10px] text-gray-400">ÊõºË∞∑Â∏Ç</span>
             <span class="text-xl font-medium" id="header-temp">30¬∞</span>
        </div>
    </header>

    <div id="tab-home" class="section active px-5 py-4">
        
        <div class="mb-6">
            <h3 class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider ml-1">Hourly Forecast</h3>
            <div class="bg-white/80 backdrop-blur rounded-2xl p-4 shadow-sm border border-white overflow-x-auto hide-scrollbar flex gap-6 weather-scroll" id="weather-strip">
                </div>
        </div>

        <div class="bg-white rounded-[32px] p-6 shadow-card mb-8 relative overflow-hidden border border-white">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-50 rounded-full z-0 opacity-50"></div>
            <h2 class="text-lg font-bold text-jp-text mb-5 relative z-10">Dashboard</h2>
            <div class="flex gap-4 mb-5 relative z-10">
                <div class="flex-1 bg-gray-50 rounded-2xl p-4 flex flex-col justify-between h-24">
                    <span class="text-[10px] text-gray-400 font-bold">ÂåØÁéá (TWD)</span>
                    <span class="text-2xl font-bold text-jp-text mt-1" id="dash-rate">...</span>
                </div>
                <div class="flex-1 bg-gray-50 rounded-2xl p-4 flex flex-col justify-between h-24">
                    <span class="text-[10px] text-gray-400 font-bold">ÂÖ¨Ë≤ªÈ§òÈ°ç</span>
                    <span class="text-xl font-bold text-jp-green mt-1 truncate" id="home-fund-display">‡∏ø 0</span>
                </div>
            </div>
            <div class="bg-gray-100 rounded-xl px-4 py-3 flex items-center justify-between relative z-10">
                <div class="flex-1 mr-2">
                    <input type="text" id="thai-input" placeholder="Ëº∏ÂÖ•‰∏≠Êñá... (ÁøªË≠ØÊ≥∞Êñá)" class="w-full bg-transparent text-sm text-jp-text font-medium outline-none placeholder-gray-400">
                </div>
                <button onclick="translateThai()" class="text-gray-400 hover:text-jp-accent active:scale-95 transition"><i class="fas fa-volume-up text-lg"></i></button>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-20">
             <button onclick="switchTab('tab-checklist')" class="bg-white p-5 rounded-2xl shadow-card text-left flex flex-col justify-between h-32 active:scale-95 transition border border-white">
                <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-jp-blue"><i class="fas fa-suitcase"></i></div>
                <div>
                    <span class="text-sm font-bold block text-jp-text">Ë°åÊùé & Ë≥áË®ä</span>
                    <span class="text-xs text-gray-400" id="home-check-progress">0% Ready</span>
                </div>
            </button>
            <button onclick="switchTab('tab-account')" class="bg-white p-5 rounded-2xl shadow-card text-left flex flex-col justify-between h-32 active:scale-95 transition border border-white">
                <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center text-jp-red"><i class="fas fa-wallet"></i></div>
                <div>
                    <span class="text-sm font-bold block text-jp-text">ÂàÜÂ∏≥Ë®àÁÆóÊ©ü</span>
                    <span class="text-xs text-gray-400" id="home-account-status">Ë®ò‰∏ÄÁ≠Ü</span>
                </div>
            </button>
        </div>
    </div>

    <div id="tab-itinerary" class="section pb-24">
        <div class="sticky top-[72px] z-30 bg-[#F9F8F4] pt-2 pb-2 pl-4 pr-2 shadow-sm flex items-center">
            <div class="flex-1 overflow-x-auto hide-scrollbar flex gap-3 pr-4" id="day-tabs">
                </div>
            <div class="flex gap-2 flex-shrink-0 pl-2 border-l border-gray-200 bg-[#F9F8F4]">
                <button onclick="openSortModal()" class="w-9 h-9 rounded-full bg-white border border-gray-200 text-gray-500 flex items-center justify-center shadow-sm active:scale-90 transition"><i class="fas fa-sort text-xs"></i></button>
                <button onclick="openEditSpot()" class="w-9 h-9 rounded-full bg-jp-text text-white flex items-center justify-center shadow-md active:scale-90 transition"><i class="fas fa-plus text-xs"></i></button>
            </div>
        </div>
        
        <div id="itinerary-content" class="px-5 mt-4 min-h-[50vh]"></div>
        
        <div class="px-5 mt-8 mb-4">
             <h3 class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">‰ΩèÂÆøË≥áË®ä</h3>
             <div class="bg-white rounded-2xl p-4 shadow-card mb-3 flex items-center gap-4 border border-white">
                 <div class="w-10 h-10 rounded-full bg-jp-blue/10 flex items-center justify-center text-jp-blue"><i class="fas fa-bed"></i></div>
                 <div>
                     <p class="text-[10px] font-bold text-jp-blue mb-1">12/23 - 12/25 (China Town)</p>
                     <p class="text-sm font-bold text-jp-text">B2 Chinatown Hotel</p>
                 </div>
                 <a href="https://maps.app.goo.gl/ZjNM4vwDCNQdAq637" target="_blank" class="ml-auto w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400"><i class="fas fa-location-arrow text-xs"></i></a>
             </div>
             <div class="bg-white rounded-2xl p-4 shadow-card flex items-center gap-4 border border-white">
                 <div class="w-10 h-10 rounded-full bg-jp-accent/10 flex items-center justify-center text-jp-accent"><i class="fas fa-hotel"></i></div>
                 <div>
                     <p class="text-[10px] font-bold text-jp-accent mb-1">12/25 - 12/27 (Thong Lor)</p>
                     <p class="text-sm font-bold text-jp-text">Jasmine 59 Hotel</p>
                 </div>
                 <a href="https://maps.app.goo.gl/DmVbJdwrbkwQ7p8K6" target="_blank" class="ml-auto w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400"><i class="fas fa-location-arrow text-xs"></i></a>
             </div>
        </div>
    </div>

    <div id="tab-account" class="section px-4 py-4 pb-24">
        <div class="bg-white rounded-3xl shadow-float p-6 border border-white relative mb-6">
            <div class="flex justify-between items-start mb-6">
                <h2 class="text-xl font-bold text-jp-text">Ë®òÂ∏≥</h2>
                <div class="text-right">
                    <p class="text-[10px] text-gray-400 uppercase">Balance</p>
                    <p class="text-xl font-bold text-jp-accent" id="acc-fund-display">‡∏ø 0</p>
                </div>
            </div>
            
            <div class="flex justify-between gap-2 overflow-x-auto hide-scrollbar mb-6" id="cat-container"></div>
            
            <div class="flex gap-3 mb-5">
                 <div class="flex bg-gray-50 rounded-xl p-1 h-16 items-center">
                    <button onclick="setCurrency('TWD')" id="cur-twd" class="px-3 h-full rounded-lg text-xs font-bold text-gray-400">TWD</button>
                    <button onclick="setCurrency('THB')" id="cur-thb" class="px-3 h-full rounded-lg bg-white shadow-sm text-jp-text font-bold">THB</button>
                </div>
                <div class="flex-1 bg-gray-50 rounded-2xl px-5 flex flex-col justify-center">
                    <input type="number" id="amt-input" placeholder="0" class="w-full text-right text-3xl font-bold text-jp-text bg-transparent outline-none p-0">
                </div>
            </div>
            
            <div class="mb-5">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-xs text-gray-400 font-bold">‰ªòÊ¨æ‰∫∫</p>
                    <button onclick="editUsers()" class="text-[10px] text-blue-400">Á∑®ËºØ</button>
                </div>
                <div class="flex flex-wrap gap-2" id="payer-container"></div>
            </div>

            <div class="flex gap-2 mb-5">
                <input type="text" id="note-input" placeholder="ÂÇôË®ª (Â¶Ç: 7-11 Âï§ÈÖí)" class="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm outline-none">
            </div>

            <button onclick="submitTx()" class="w-full bg-jp-text text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition">Á¢∫Ë™çÊñ∞Â¢û</button>
        </div>
        
        <div id="tx-history" class="space-y-3 pb-10"></div>
    </div>
    
    <div id="tab-checklist" class="section px-5 py-4 pb-24">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold">Ê∫ñÂÇôÊ∏ÖÂñÆ</h2>
            <div class="flex gap-2">
                <button onclick="addChecklistCategory()" class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center"><i class="fas fa-folder-plus text-xs"></i></button>
                <button onclick="addChecklistItem()" class="w-8 h-8 rounded-full bg-jp-accent text-white flex items-center justify-center shadow-md"><i class="fas fa-plus text-xs"></i></button>
            </div>
        </div>
        <div id="checklist-container"></div>
        
        <div class="mt-8 space-y-4">
             <div class="bg-gradient-to-r from-red-50 to-white rounded-2xl p-5 border border-red-100">
                 <h4 class="text-xs text-red-400 mb-3 font-bold tracking-wider">EMERGENCY</h4>
                 <div class="flex justify-between items-center mb-2">
                     <span class="text-sm font-bold text-jp-text">ËßÄÂÖâË≠¶ÂØü</span>
                     <a href="tel:1155" class="bg-red-500 text-white px-3 py-1 rounded-lg text-xs font-bold shadow-sm">1155</a>
                 </div>
                 <div class="flex justify-between items-center">
                     <span class="text-sm font-bold text-jp-text">ÊïëË≠∑Ëªä</span>
                     <a href="tel:1669" class="bg-red-500 text-white px-3 py-1 rounded-lg text-xs font-bold shadow-sm">1669</a>
                 </div>
             </div>
        </div>
    </div>
    
    <div id="tab-settings" class="section px-5 py-4 pb-24">
        <h2 class="text-xl font-bold mb-6">Ë®≠ÂÆö</h2>
        <div class="bg-white rounded-2xl p-5 shadow-card mb-4">
            <button onclick="hardReset()" class="w-full text-left text-red-500 font-bold text-sm py-2">ÈáçÁΩÆÊâÄÊúâË≥áÊñô</button>
        </div>
    </div>

    <nav class="fixed bottom-6 left-5 right-5 h-16 bg-white/90 backdrop-blur-md rounded-2xl flex justify-around items-center shadow-float z-50 border border-white/50">
        <button onclick="switchTab('tab-home')" class="nav-btn active flex flex-col items-center gap-1 text-gray-300" data-target="tab-home"><i class="fas fa-home text-lg"></i></button>
        <button onclick="switchTab('tab-itinerary')" class="nav-btn flex flex-col items-center gap-1 text-gray-300" data-target="tab-itinerary"><i class="fas fa-map-marked-alt text-lg"></i></button>
        <div class="relative -top-6">
            <button onclick="switchTab('tab-account')" class="w-14 h-14 bg-jp-text rounded-full shadow-2xl flex items-center justify-center text-white text-xl transform hover:scale-105 transition active:scale-95 border-4 border-[#F9F8F4]"><i class="fas fa-plus"></i></button>
        </div>
        <button onclick="switchTab('tab-checklist')" class="nav-btn flex flex-col items-center gap-1 text-gray-300" data-target="tab-checklist"><i class="fas fa-suitcase text-lg"></i></button>
        <button onclick="switchTab('tab-settings')" class="nav-btn flex flex-col items-center gap-1 text-gray-300" data-target="tab-settings"><i class="fas fa-cog text-lg"></i></button>
    </nav>

    <div id="detail-modal" class="bottom-sheet">
        <div class="sheet-overlay" onclick="closeDetailModal()"></div>
        <div class="sheet-content">
            <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
            
            <div id="detail-content"></div>
        </div>
    </div>

    <div id="speak-modal" class="speak-modal" onclick="this.classList.remove('open')">
        <p class="text-gray-400 text-sm mb-4">Áµ¶Âè∏Ê©ü / Â∫óÂì°Áúã</p>
        <h1 id="speak-text" class="text-white text-6xl font-bold leading-tight break-words">...</h1>
        <p class="text-gray-500 text-xs mt-10">ÈªûÊìä‰ªªÊÑèËôïÈóúÈñâ</p>
    </div>

    <div id="sort-modal" class="modal-overlay fixed inset-0 bg-black/50 z-[9000] hidden items-center justify-center">
        <div class="bg-white w-[90%] rounded-3xl p-6 shadow-2xl max-h-[70vh] flex flex-col">
            <h3 class="font-bold text-lg mb-4 text-jp-text">Ë™øÊï¥È†ÜÂ∫è</h3>
            <div id="sort-list-container" class="overflow-y-auto flex-1 mb-4"></div>
            <div class="flex gap-3">
                <button onclick="document.getElementById('sort-modal').classList.remove('flex');document.getElementById('sort-modal').classList.add('hidden')" class="flex-1 py-3 rounded-xl bg-gray-100 text-sm font-bold text-gray-500">ÂèñÊ∂à</button>
                <button onclick="confirmSort()" class="flex-1 py-3 rounded-xl bg-jp-text text-white text-sm font-bold">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>

    <div id="itinerary-modal" class="modal-overlay fixed inset-0 bg-black/50 z-[9000] hidden items-center justify-center">
        <div class="bg-white w-[90%] rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg text-jp-text mb-4" id="spot-modal-title">Á∑®ËºØÊôØÈªû</h3>
            <input type="hidden" id="spot-index">
            <div class="space-y-3">
                <div class="flex gap-2">
                    <input type="text" id="spot-time" placeholder="ÊôÇÈñì" class="w-1/3 bg-gray-50 rounded-xl p-3 text-sm">
                    <input type="text" id="spot-name" placeholder="ÂêçÁ®±" class="w-2/3 bg-gray-50 rounded-xl p-3 text-sm font-bold">
                </div>
                <input type="text" id="spot-thai" placeholder="Ê≥∞ÊñáÂêçÁ®± (Áµ¶Âè∏Ê©üÁúã)" class="w-full bg-gray-50 rounded-xl p-3 text-sm font-serif text-jp-blue">
                <textarea id="spot-deep-desc" placeholder="Ê∑±Â∫¶‰ªãÁ¥π..." class="w-full bg-gray-50 rounded-xl p-3 text-sm h-24"></textarea>
                <input type="text" id="spot-icon" placeholder="Icon (fa-xxx)" class="w-full bg-gray-50 rounded-xl p-3 text-xs">
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="deleteSpot()" id="btn-delete-spot" class="p-3 rounded-xl bg-red-50 text-red-500"><i class="fas fa-trash"></i></button>
                <button onclick="document.getElementById('itinerary-modal').classList.remove('flex');document.getElementById('itinerary-modal').classList.add('hidden')" class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-500 font-bold text-sm">ÂèñÊ∂à</button>
                <button onclick="saveSpot()" class="flex-1 py-3 rounded-xl bg-jp-text text-white font-bold text-sm">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>

</div>

<script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxYeyHua8VRjHu3dHbP3glwWcFf5zClFG_drBD9gR_j9MZpcGf6uajQUzmOw_Au_o0o/exec';
    
    // --- V19 DATA: RICH CONTENT & THAI NAMES ---
    const DEFAULT_ITINERARY = [
        { "day": 1, "date": "12/23 (‰∫å)", "spots": [ 
            { "time": "18:00", "name": "È´òÈõÑÂá∫Áôº", "thai_name": "‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô", "desc": "FD235 ‚úàÔ∏è", "icon": "fa-plane", "color": "text-blue-500", "deep_desc": "Ë´ãÊèêÊó© 2.5 Â∞èÊôÇÊäµÈÅîÊ©üÂ†¥„ÄÇ‰∫ûËà™‰ΩçÊñºÈ´òÈõÑÂ∞èÊ∏ØÊ©üÂ†¥ÂúãÈöõËà™Âªà„ÄÇË®òÂæóÂÖà‰∏ãËºâÂ•Ω Grab App ‰∏¶Á∂ÅÂÆö‰ø°Áî®Âç°ÔºåÂá∫Ê©üÂ†¥ÂæåÁõ¥Êé•Âè´ËªäÊØîËºÉÊñπ‰æø„ÄÇ" }, 
            { "time": "22:30", "name": "B2 Âîê‰∫∫Ë°óÈ£ØÂ∫ó", "thai_name": "‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°‡∏ö‡∏µ‡∏ó‡∏π", "desc": "Check-in", "icon": "fa-bed", "color": "text-gray-500", "deep_desc": "B2 Bangkok Premier Hotel ‰ΩçÊñºÂÆâÈùúÁöÑÂ∑∑ÂºÑÂÖßÔºåËµ∞Ë∑ØÂà∞ Wat Mangkon MRT Á´ôÁ¥Ñ 5-8 ÂàÜÈêò„ÄÇCheck-in ÈúÄË¶ÅË≠∑ÁÖßÔºåÊäºÈáëÈÄöÂ∏∏ÁÇ∫ 500-1000 Ê≥∞Èäñ„ÄÇ" },
            { "time": "23:00", "name": "Âîê‰∫∫Ë°óÂÆµÂ§ú", "thai_name": "‡πÄ‡∏¢‡∏≤‡∏ß‡∏£‡∏≤‡∏ä", "desc": "ËÄÄËèØÂäõË∑ØË¶ìÈ£ü", "icon": "fa-utensils", "color": "text-orange-500", "deep_desc": "ÊõºË∞∑Âîê‰∫∫Ë°óÊòØÂÖ®ÁêÉËëóÂêçÁöÑÁæéÈ£üÂ§©Â†ÇÔºÅ\n\nÊé®Ëñ¶ÂøÖÂêÉÔºö\n1. **T&K Seaood (Á∂†Ëâ≤Âà∂Êúç)**: ÂøÖÈªûÁÉ§Â§ßËù¶„ÄÅÂíñÂì©ËûÉËüπ„ÄÇ\n2. **Á≤øÊ±Å (Kway Chap)**: Êç≤Ëµ∑‰æÜÁöÑÊùøÊ¢ùÈÖç‰∏äËÉ°Ê§íÊπØÈ†≠ËàáËÑÜÁöÆÁáíËÇâ„ÄÇ\n3. **ÁîúÈªû**: Á¢≥ÁÉ§È∫µÂåÖ (ÁàÜÊºøÈ§°Êñô)„ÄÇ" } 
        ] },
        { "day": 2, "date": "12/24 (‰∏â)", "spots": [ 
            { "time": "09:30", "name": "Áü≥ÈæçËªçË∑Ø", "thai_name": "‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏Å‡∏£‡∏∏‡∏á", "desc": "ËÄÅÂüéÂçÄÊï£Ê≠•", "icon": "fa-walking", "color": "text-gray-500", "deep_desc": "Charoen Krung ÊòØÊõºË∞∑Á¨¨‰∏ÄÊ¢ùË•øÂºèÈ¶¨Ë∑ØÔºåÂÖÖÊªøÊÆñÊ∞ëÈ¢®Ê†ºÂª∫ÁØâ„ÄÇ\n\nüì∏ **ÊãçÁÖßÈªû**: ËàäÊµ∑ÈóúÂ§ßÊ®ì (Old Custom House)„ÄÅTalad Noi Â∑∑ÂºÑË£°ÁöÑË°óÈ†≠Â°óÈ¥â„ÄÇ\n‚òï **ÂøÖÂéª**: ‰ªÅÂíåÂúíÊ∂ºËå∂„ÄÅËààËààË±ÜÊºø (ÁôæÂπ¥ËÄÅÂ∫ó)„ÄÇ" }, 
            { "time": "11:00", "name": "Ëá•‰ΩõÂØ∫", "thai_name": "‡∏ß‡∏±‡∏î‡πÇ‡∏û‡∏ò‡∏¥‡πå", "desc": "Wat Pho", "icon": "fa-gopuram", "color": "text-yellow-600", "deep_desc": "ÊõºË∞∑ÊúÄÂè§ËÄÅÁöÑÂØ∫Âªü‰πã‰∏ÄÔºå‰ª•Èï∑ÈÅî 46 ÂÖ¨Â∞∫ÁöÑÈáëËâ≤Ëá•‰ΩõËÅûÂêç„ÄÇÈÄôË£°‰πüÊòØÊ≥∞ÂºèÊåâÊë©ÁöÑÁôºÊ∫êÂú∞ÔºÅ\n\nüí° **Â∞èÁü•Ë≠ò**: Ê≥®ÊÑèÁúãËá•‰ΩõÁöÑËÖ≥Â∫ïÔºåÁî®ÁèçÁè†ÊØçË≤ùÈë≤Âµå‰∫Ü 108 ÂÄã‰ΩõÈôÄÁ••ÁëûÂúñÊ°à„ÄÇÂèÉËßÄÊôÇÈúÄËÑ´ÈûãÔºåÁ©øËëóÈúÄÈÅéËÜù„ÄÇ" }, 
            { "time": "13:30", "name": "ÈÑ≠ÁéãÂªü", "thai_name": "‡∏ß‡∏±‡∏î‡∏≠‡∏£‡∏∏‡∏ì", "desc": "ÈªéÊòéÂØ∫", "icon": "fa-store", "color": "text-gray-500", "deep_desc": "ÂèàÁ®±ÈªéÊòéÂØ∫ÔºåÊΩîÁôΩÁöÑÂ°îË∫´Èë≤ÂµåËëó‰æÜËá™‰∏≠ÂúãÁöÑÂΩ©Ëâ≤Á¢éÁì∑ÁâáÔºåÂú®ÈôΩÂÖâ‰∏ãÈñÉÈñÉÁôºÂÖâ„ÄÇ\n\nüì∏ **ÊîªÁï•**: Âª∫Ë≠∞Âú®Â∞çÂ≤∏ÁöÑÈ§êÂª≥ (Â¶Ç The Deck) Ê¨£Ë≥ûÊó•ËêΩÊôÇÂàÜÁöÑÂâ™ÂΩ±„ÄÇÊàñÊòØÊê≠‰πòÊé•ÈßÅËàπÁõ¥Êé•Âà∞ÂªüÂè£ÂèÉËßÄ„ÄÇ" }, 
            { "time": "19:00", "name": "Êò≠Êä´ËÄ∂Ê≤≥ÈÅäËàπ", "thai_name": "‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤", "desc": "River City", "icon": "fa-ship", "color": "text-blue-600", "deep_desc": "Êôö‰∏äÁöÑÊò≠Êä´ËÄ∂Ê≤≥ËàáÁôΩÂ§©Êà™ÁÑ∂‰∏çÂêå„ÄÇÈÅäËàπÈÄöÂ∏∏ÂåÖÂê´Ëá™Âä©ÊôöÈ§êËàá Live Band„ÄÇËàπË°åÁ∂ìÈÅéÂ§ßÁöáÂÆÆËàáÈÑ≠ÁéãÂªüÊôÇÔºåÊâì‰∏äÁáàÂÖâÁöÑÂè§ËπüÈùûÂ∏∏Â£ØËßÄÔºåÊòØÊõºË∞∑ÊúÄÊµ™Êº´ÁöÑÈ´îÈ©ó‰πã‰∏Ä„ÄÇ" }
        ] },
        { "day": 3, "date": "12/25 (Âõõ)", "spots": [ 
            { "time": "10:30", "name": "Âµ©Ë∂äË∑Ø", "thai_name": "‡∏ñ‡∏ô‡∏ô‡∏ó‡∏£‡∏á‡∏ß‡∏≤‡∏î", "desc": "ÊñáÈùíÂíñÂï°Ë°ó", "icon": "fa-coffee", "color": "text-orange-800", "deep_desc": "Song Wat Road ÊõæÁ∂ìÊòØÈ¶ôÊñôËàáÂ§ßÁ±≥ÁöÑË≤øÊòì‰∏≠ÂøÉÔºåÁèæÂú®ËÆäË∫´ÁÇ∫ÊõºË∞∑ÊúÄÊΩÆÁöÑÊñáÈùíË°óÂçÄ„ÄÇ\n\nüè† **ÁâπËâ≤**: ËÄÅÂÄâÂ∫´ÊîπÂª∫ÁöÑËóùÂªäËàáÂíñÂï°Âª≥ (Â¶Ç FV Cafe)„ÄÇ\nüêò **ÂøÖÊãç**: ÁâÜ‰∏äÁöÑÂ§ßË±°Â°óÈ¥âÔºå‰ª•ÂèäÂÖÖÊªøÊ≠≤ÊúàÁóïË∑°ÁöÑ‰∏≠ÂºèËÄÅÂª∫ÁØâ„ÄÇ" },
            { "time": "14:00", "name": "ÈÄöÁæÖÂïÜÂúà", "thai_name": "‡∏ó‡∏≠‡∏á‡∏´‡∏•‡πà‡∏≠", "desc": "The Commons", "icon": "fa-glass-cheers", "color": "text-purple-500", "deep_desc": "Thong Lor ÊòØÊõºË∞∑ÁöÑÂØå‰∫∫ÂçÄËàáÊó•Êú¨‰∫∫ËÅöÂ±ÖÂú∞ÔºåÂÖÖÊªøÁ≤æÁ∑ªÁöÑÂíñÂï°Âª≥ËàáÈÖíÂêß„ÄÇ\n\nüè¢ **The Commons**: Ê∏ÖÊ∞¥Ê®°Ë®≠Ë®àÁöÑÁ§æÂçÄÂïÜÂ†¥ÔºåÈÅ©ÂêàÂú®ÈÇ£Ë£°ÁöÑÊà∂Â§ñÈöéÊ¢ØÂñùÂíñÂï°ÁôºÂëÜ„ÄÇ\nüç∏ **Â§úÁîüÊ¥ª**: ÈÄôË£°ÊúâË®±Â§öÈö±ËóèÂºèÈÖíÂêß (Speakeasy Bar)ÔºåÂ¶Ç Find The Locker Room„ÄÇ" },
            { "time": "Eve", "name": "ICONSIAM", "thai_name": "‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏™‡∏¢‡∏≤‡∏°", "desc": "ÂÆ§ÂÖßÊ∞¥‰∏äÂ∏ÇÂ†¥", "icon": "fa-shopping-bag", "color": "text-pink-600", "deep_desc": "ÊõºË∞∑ÊúÄÊµÆË™áÁöÑÁôæË≤®ÂÖ¨Âè∏ÔºÅ\n\n‚ú® **‰∫ÆÈªû**: G Ê®ìÁöÑ SookSiam ÊâìÈÄ†‰∫ÜÂÆ§ÂÖßÊ∞¥‰∏äÂ∏ÇÂ†¥ÔºåËÆì‰Ω†‰∏çÁî®Êõ¨Â§™ÈôΩ‰πüËÉΩÂêÉÂà∞Ê≥∞ÂúãÂêÑÂú∞ÁöÑË∑ØÈÇäÊî§ÁæéÈ£ü„ÄÇÊôö‰∏äÁöÑÊ∞¥ËàûÁßÄ (River Park) ‰πüÂæàÂÄºÂæó‰∏ÄÁúã„ÄÇ" }
        ] },
        { "day": 4, "date": "12/26 (‰∫î)", "spots": [ 
            { "time": "08:00", "name": "ÂåÖËªä‰∏ÄÊó•ÈÅä", "thai_name": "‡∏£‡∏ñ‡∏ï‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏´‡∏°‡∏≤", "desc": "ÂâçÂæÄÁæéÂäü", "icon": "fa-car", "color": "text-red-500", "deep_desc": "Êú¨Êó•Ë°åÁ®ãËºÉÈÅ†ÔºåÂª∫Ë≠∞Ê∫ñÊôÇÂá∫Áôº„ÄÇËªäÁ®ãÁ¥Ñ 1.5 - 2 Â∞èÊôÇ„ÄÇË´ãÊ∫ñÂÇôÂ•ΩÊöàËªäËó•ËàáÈò≤Êõ¨Áî®ÂìÅ„ÄÇ" },
            { "time": "10:00", "name": "ÁæéÂäüÈêµÈÅìÂ∏ÇÂ†¥", "thai_name": "‡∏ï‡∏•‡∏≤‡∏î‡∏£‡πà‡∏°‡∏´‡∏∏‡∏ö", "desc": "ÁúãÁÅ´ËªäÈÄ≤Á´ô", "icon": "fa-train", "color": "text-gray-600", "deep_desc": "‰∏ñÁïåÂ•áËßÄÔºÅÊî§Ë≤©Áõ¥Êé•Êì∫Âú®ÈêµËªå‰∏äÔºåÁÅ´Ëªä‰æÜÊôÇÊâçÊî∂Ê£öÂ≠ê„ÄÇ\n\nüöÇ **ÊôÇÂàªË°®**: ÁÅ´ËªäÁ∂ìÈÅéÊôÇÈñìÁ¥ÑÁÇ∫ 8:30, 11:10, 14:30, 17:40 (Ê≥∞ÂúãÁÅ´ËªäÂ∏∏Ë™§ÈªûÔºåÂÉÖ‰æõÂèÉËÄÉ)„ÄÇÊúÄ‰Ω≥ÊãçÊîùÈªûÊòØÂú®ÁÅ´ËªäÈ†≠Á∂ìÈÅéÊôÇÈåÑÂΩ±„ÄÇ" },
            { "time": "12:00", "name": "‰∏πÂ´©ËééÊúµ", "thai_name": "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏™‡∏∞‡∏î‡∏ß‡∏Å", "desc": "Ê∞¥‰∏äÂ∏ÇÂ†¥", "icon": "fa-water", "color": "text-blue-400", "deep_desc": "ÊúÄÁ∂ìÂÖ∏ÁöÑÊ∞¥‰∏äÂ∏ÇÂ†¥ÔºåÈ´îÈ©óÊâãÊêñËàπÂ°ûËàπÁöÑÊ®ÇË∂£„ÄÇËàπ‰∏äË≤©Ë≥£ÁöÑÊ§∞Â≠êÂÜ∞Ê∑áÊ∑ã„ÄÅËäíÊûúÁ≥ØÁ±≥È£ØÂèØ‰ª•Áõ¥Êé•Ë≥ºË≤∑‰∫´Áî®„ÄÇ\n\n‚ö†Ô∏è **Ê≥®ÊÑè**: Á¥ÄÂøµÂìÅÈñãÂÉπÈÄöÂ∏∏ÂæàÈ´òÔºåÊÆ∫ÂÉπË´ãÂæû 3 ÊäòÈñãÂßãÊÆ∫ÔºÅ" }
        ] },
        { "day": 5, "date": "12/27 (ÂÖ≠)", "spots": [ 
            { "time": "10:00", "name": "ÊÅ∞ÂúñÊÅ∞Â∏ÇÈõÜ", "thai_name": "‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏î‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£", "desc": "ÈÄ±Êú´Â∏ÇÈõÜ", "icon": "fa-store-alt", "color": "text-green-600", "deep_desc": "‰∏ñÁïåÊúÄÂ§ßÁöÑÈÄ±Êú´Â∏ÇÈõÜ (Chatuchak)ÔºåË∂ÖÈÅé 15,000 ÂÄãÊî§‰ΩçÔºÅ\n\nüõçÔ∏è **ÊîªÁï•**: ÁúãÂà∞ÂñúÊ≠°ÁöÑÂ∞±Ë≤∑ÔºåÂõ†ÁÇ∫ÂõûÈ†≠ÂæàÈõ£ÂÜçÊâæÂà∞Âêå‰∏ÄÂÆ∂Â∫ó„ÄÇ‰∏ªË¶ÅÂàÜÁÇ∫ÊúçÈ£æÂçÄ„ÄÅÈ¶ôÊ∞õÂçÄ„ÄÅÊâãÂ∑•ËóùÂìÅÂçÄ„ÄÇË®òÂæóÂ§öË£úÂÖÖÊ∞¥ÂàÜÔºåÈùûÂ∏∏ÁÜ±ÔºÅ" },
            { "time": "Flight", "name": "ËøîÂè∞", "thai_name": "‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô", "desc": "ÂâçÂæÄÊ©üÂ†¥", "icon": "fa-plane-departure", "color": "text-blue-500", "deep_desc": "Âª∫Ë≠∞ÊèêÊó© 3 Â∞èÊôÇÊäµÈÅîÊ©üÂ†¥„ÄÇËã•ÊúâÈÄÄÁ®ÖÂñÆ (VAT Refund)ÔºåË®òÂæóÂÖàÂú®Ê©üÂ†¥Â§ßÂª≥ËìãÁ´†ÔºåÈÅéÊµ∑ÈóúÂæåÂÜçÂéªÈ†òÈå¢„ÄÇ" }
        ] }
    ];

    let state = {
        users: ["ÂÜ†‰ªî","Â∞èËä≥","Áé†ÂÆá","Â©ïËåπ","Ëäù‰º∂","ÂÖ¨Ë≤ªÂåÖ"],
        fundBalance: 0,
        currency: 'THB',
        transactions: [],
        checklist: [{"title":"Ë≠â‰ª∂","items":[{"name":"Ë≠∑ÁÖß","checked":true},{"name":"eSIM","checked":false}]}],
        itinerary: DEFAULT_ITINERARY, 
        currentDay: 0
    };
    
    let sortable = null;

    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        updateDate();
        renderWeatherStrip(); // Mock Weather
        renderDayTabs();
        renderItinerary();
        renderAccCats();
        renderPayers();
        updateFundDisplay();
        renderHistory();
        renderChecklist();
        autoSync();
    });

    // --- NEW: IPHONE STYLE WEATHER ---
    function renderWeatherStrip() {
        // Mock data logic for demo
        const hours = [
            {t:'Now', i:'fa-sun', temp:'30¬∞'},
            {t:'13:00', i:'fa-sun', temp:'31¬∞'},
            {t:'14:00', i:'fa-cloud-sun', temp:'31¬∞'},
            {t:'15:00', i:'fa-cloud', temp:'30¬∞'},
            {t:'16:00', i:'fa-cloud-rain', temp:'28¬∞'},
            {t:'17:00', i:'fa-cloud-showers-heavy', temp:'27¬∞'},
            {t:'18:00', i:'fa-moon', temp:'26¬∞'},
            {t:'19:00', i:'fa-moon', temp:'26¬∞'},
        ];
        
        const html = hours.map(h => `
            <div class="weather-item flex flex-col items-center gap-2 min-w-[50px]">
                <span class="text-[10px] font-bold text-gray-400">${h.t}</span>
                <i class="fas ${h.i} text-xl ${h.i.includes('sun')?'text-yellow-400':h.i.includes('rain')?'text-blue-400':'text-gray-400'}"></i>
                <span class="text-sm font-bold text-jp-text">${h.temp}</span>
            </div>
        `).join('');
        document.getElementById('weather-strip').innerHTML = html;
        document.getElementById('header-temp').innerText = "30¬∞C";
    }
    
    // --- V19 ITINERARY RENDER (CARD & MODAL) ---
    function renderDayTabs() {
        const tabs = document.getElementById('day-tabs');
        tabs.innerHTML = state.itinerary.map((d, i) => `
            <button onclick="setDay(${i})" class="flex-shrink-0 px-5 py-2 rounded-2xl border transition duration-300 ${state.currentDay===i ? 'bg-jp-text text-white border-jp-text shadow-md transform scale-105' : 'bg-white text-gray-400 border-gray-100'}">
                <span class="block text-xs font-bold">Day ${d.day}</span>
                <span class="text-[10px] whitespace-nowrap opacity-80">${d.date.split(' ')[0]}</span>
            </button>
        `).join('');
        
        // Auto scroll to active tab
        setTimeout(() => {
            const active = tabs.children[state.currentDay];
            if(active) active.scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'});
        }, 100);
    }
    
    function setDay(i) { state.currentDay = i; renderDayTabs(); renderItinerary(); }

    function renderItinerary() {
        const d = state.itinerary[state.currentDay];
        const c = document.getElementById('itinerary-content');
        
        if(!d.spots || d.spots.length === 0) { 
            c.innerHTML = `<div class="text-center py-10 text-gray-300 flex flex-col items-center gap-2"><i class="fas fa-map-signs text-3xl opacity-20"></i><span class="text-sm">Â∞öÊú™ÂÆâÊéíË°åÁ®ã</span></div>`; 
            return; 
        }
        
        c.innerHTML = d.spots.map((s, idx) => `
            <div class="timeline-item group ${idx===0?'active':''}">
                <div class="timeline-dot"></div>
                <span class="timeline-time">${s.time}</span>
                
                <div onclick="openDetailModal(${idx})" class="spot-card bg-white rounded-2xl p-4 shadow-card border border-white relative cursor-pointer overflow-hidden">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center flex-shrink-0 text-xl text-gray-400">
                            <i class="fas ${s.icon} ${s.color||''}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base font-bold text-jp-text truncate">${s.name}</h3>
                            <p class="text-xs text-gray-400 truncate">${s.desc}</p>
                        </div>
                        <i class="fas fa-chevron-right text-gray-200 text-xs"></i>
                    </div>
                    <button onclick="event.stopPropagation();openEditSpot(${idx})" class="absolute top-2 right-2 w-6 h-6 rounded-full bg-transparent text-gray-200 hover:text-jp-accent flex items-center justify-center"><i class="fas fa-pen text-[10px]"></i></button>
                </div>
            </div>
        `).join('');
    }

    // --- NEW: DETAIL MODAL LOGIC ---
    function openDetailModal(index) {
        const spot = state.itinerary[state.currentDay].spots[index];
        const modal = document.getElementById('detail-modal');
        const content = document.getElementById('detail-content');
        
        content.innerHTML = `
            <div class="flex items-start justify-between mb-4">
                <div>
                    <span class="px-2 py-1 bg-gray-100 rounded text-[10px] text-gray-500 font-bold mb-2 inline-block">${spot.time}</span>
                    <h2 class="text-2xl font-bold text-jp-text leading-tight">${spot.name}</h2>
                    <p class="text-sm text-gray-400 font-serif italic mt-1">${spot.desc}</p>
                </div>
                <div class="w-12 h-12 rounded-full bg-gray-50 flex items-center justify-center text-2xl">
                    <i class="fas ${spot.icon} ${spot.color}"></i>
                </div>
            </div>
            
            <button onclick="openSpeak('${spot.thai_name || spot.name}')" class="w-full bg-jp-text text-white rounded-xl py-3 mb-6 shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                <i class="fas fa-comment-dots"></i>
                <span class="font-bold text-sm">Áµ¶Âè∏Ê©ü / Â∫óÂì°Áúã</span>
            </button>
            
            <div class="prose prose-sm text-gray-600 leading-relaxed text-sm mb-6 bg-mag-paper p-4 rounded-xl border border-yellow-50">
                ${spot.deep_desc ? spot.deep_desc.replace(/\n/g, '<br>') : 'Êö´ÁÑ°Ê∑±Â∫¶‰ªãÁ¥π...'}
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(spot.name + ' Bangkok')}" target="_blank" class="flex items-center justify-center gap-2 bg-gray-100 py-3 rounded-xl text-xs font-bold text-gray-600 hover:bg-gray-200 transition">
                    <i class="fas fa-map-marker-alt text-red-400"></i> Google Map
                </a>
                <a href="https://www.google.com/search?q=${encodeURIComponent('ÊõºË∞∑ ' + spot.name + ' ÊîªÁï•')}" target="_blank" class="flex items-center justify-center gap-2 bg-gray-100 py-3 rounded-xl text-xs font-bold text-gray-600 hover:bg-gray-200 transition">
                    <i class="fab fa-google text-blue-400"></i> ÊêúÂ∞ãÊîªÁï•
                </a>
            </div>
        `;
        
        modal.classList.add('open');
    }
    
    function closeDetailModal() {
        document.getElementById('detail-modal').classList.remove('open');
    }
    
    function openSpeak(text) {
        if(!text) return alert("ÁÑ°Ê≥∞ÊñáÂêçÁ®±");
        document.getElementById('speak-text').innerText = text;
        document.getElementById('speak-modal').classList.add('open');
    }

    // --- SORTING ---
    function openSortModal() {
        const spots = state.itinerary[state.currentDay].spots;
        if(!spots || spots.length === 0) return alert("Ê≤íÊúâË°åÁ®ãÂèØÊéíÂ∫è");
        
        const container = document.getElementById('sort-list-container');
        container.innerHTML = spots.map((s, i) => `
            <div class="bg-gray-50 p-3 mb-2 rounded-xl flex items-center justify-between" data-id="${i}">
                <div class="flex items-center gap-3 overflow-hidden">
                    <i class="fas ${s.icon} text-gray-400 w-4"></i>
                    <span class="font-bold text-sm text-gray-600 truncate">${s.name}</span>
                </div>
                <i class="fas fa-bars text-gray-300 cursor-move p-2"></i>
            </div>
        `).join('');
        
        const modal = document.getElementById('sort-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        if(sortable) sortable.destroy();
        sortable = new Sortable(container, { animation: 150, handle: '.fa-bars' });
    }

    function confirmSort() {
        const newOrder = sortable.toArray();
        const currentSpots = state.itinerary[state.currentDay].spots;
        state.itinerary[state.currentDay].spots = newOrder.map(index => currentSpots[parseInt(index)]);
        saveData();
        renderItinerary();
        document.getElementById('sort-modal').classList.remove('flex');
        document.getElementById('sort-modal').classList.add('hidden');
    }

    // --- EDITING ---
    let currentEditIndex = -1;
    function openEditSpot(index = -1) {
        currentEditIndex = index;
        const modal = document.getElementById('itinerary-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        document.getElementById('spot-modal-title').innerText = index === -1 ? "Êñ∞Â¢ûË°åÁ®ã" : "Á∑®ËºØÂÖßÂÆπ";
        document.getElementById('btn-delete-spot').style.display = index === -1 ? 'none' : 'block';

        const fields = ['time', 'name', 'thai', 'deep-desc', 'icon'];
        if(index === -1) {
             fields.forEach(f => {
                 const el = document.getElementById('spot-'+f);
                 if(el) el.value = (f==='icon'?'fa-map-marker-alt':'');
             });
        } else {
            const s = state.itinerary[state.currentDay].spots[index];
            document.getElementById('spot-time').value = s.time || '';
            document.getElementById('spot-name').value = s.name || '';
            document.getElementById('spot-thai').value = s.thai_name || '';
            document.getElementById('spot-deep-desc').value = s.deep_desc || '';
            document.getElementById('spot-icon').value = s.icon || 'fa-map-marker-alt';
        }
    }

    function saveSpot() {
        const s = {
            time: document.getElementById('spot-time').value,
            name: document.getElementById('spot-name').value,
            thai_name: document.getElementById('spot-thai').value,
            deep_desc: document.getElementById('spot-deep-desc').value,
            icon: document.getElementById('spot-icon').value,
            desc: document.getElementById('spot-name').value, // Simple desc fallback
            color: 'text-gray-500'
        };
        
        if(!s.name) return alert("Ë´ãËº∏ÂÖ•ÂêçÁ®±");
        
        if(!state.itinerary[state.currentDay].spots) state.itinerary[state.currentDay].spots = [];
        
        if(currentEditIndex === -1) state.itinerary[state.currentDay].spots.push(s);
        else state.itinerary[state.currentDay].spots[currentEditIndex] = s;
        
        saveData();
        renderItinerary();
        document.getElementById('itinerary-modal').classList.remove('flex');
        document.getElementById('itinerary-modal').classList.add('hidden');
    }
    
    function deleteSpot() {
        if(confirm("Âà™Èô§Ê≠§Ë°åÁ®ã?")) {
            state.itinerary[state.currentDay].spots.splice(currentEditIndex, 1);
            saveData(); renderItinerary();
            document.getElementById('itinerary-modal').classList.remove('flex');
            document.getElementById('itinerary-modal').classList.add('hidden');
        }
    }

    // --- UTILS (Accounting, System, etc. Kept same logic, simplified code for brevity) ---
    function updateDate() { /* ... */ }
    function translateThai() { const txt=document.getElementById('thai-input').value; if(txt) window.open(`https://translate.google.com/?sl=zh-TW&tl=th&text=${encodeURIComponent(txt)}&op=translate`); }
    function switchTab(id) { document.querySelectorAll('.section').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(b=>{b.classList.remove('active');}); document.querySelector(`.nav-btn[data-target="${id}"]`).classList.add('active'); }
    
    // Updated Key V19
    function saveData() { localStorage.setItem('bkk_2025_v19', JSON.stringify(state)); }
    function loadData() { const d = localStorage.getItem('bkk_2025_v19'); if(d) try { state = {...state, ...JSON.parse(d)}; } catch(e) {} }
    function hardReset() { if(confirm("Á¢∫ÂÆöÈáçÁΩÆÊâÄÊúâË≥áÊñô?")) { localStorage.removeItem('bkk_2025_v19'); location.reload(); } }

    // Cloud & Account Logic (Standard)
    async function autoSync() { try { const res = await fetch(GOOGLE_SCRIPT_URL + '?t=' + Date.now()); const d = await res.json(); if(d && Object.keys(d).length > 0) { state = {...state, ...d}; saveData(); renderItinerary(); renderAccCats(); renderPayers(); updateFundDisplay(); renderHistory(); renderChecklist(); } } catch(e){} }
    async function syncToCloud(action) { 
        try {
            if(action==='upload') { await fetch(GOOGLE_SCRIPT_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(state)}); alert("‰∏äÂÇ≥Ë´ãÊ±ÇÂ∑≤ÁôºÈÄÅ"); }
            else { const res = await fetch(GOOGLE_SCRIPT_URL + '?t=' + Date.now()); const d = await res.json(); if(d && confirm("Ë¶ÜËìãÊú¨Ê©ü?")) { state={...state, ...d}; saveData(); location.reload(); } }
        } catch(e) { alert("ÂêåÊ≠•ÈåØË™§"); }
    }

    // Account Rendering
    let acc = { cat:'È§êÈ£≤', payer:'ÂÖ¨Ë≤ªÂåÖ', cur:'THB' };
    function renderAccCats() { const cats=[{n:'È§êÈ£≤',i:'fa-utensils'},{n:'‰∫§ÈÄö',i:'fa-car'},{n:'Ë≥ºÁâ©',i:'fa-shopping-bag'},{n:'‰ΩèÂÆø',i:'fa-bed'},{n:'ÂÖ∂‰ªñ',i:'fa-ellipsis-h'}]; document.getElementById('cat-container').innerHTML = cats.map((c,i)=>`<button onclick="acc.cat='${c.n}';renderAccCats();" class="flex-shrink-0 w-16 h-16 rounded-2xl flex flex-col items-center justify-center border transition ${acc.cat===c.n?'bg-jp-text text-white border-jp-text shadow-lg':'bg-white text-gray-400 border-gray-100'}"><i class="fas ${c.i} mb-1"></i><span class="text-xs font-bold">${c.n}</span></button>`).join(''); }
    function renderPayers() { document.getElementById('payer-container').innerHTML = state.users.map(u=>`<button onclick="acc.payer='${u}';renderPayers();" class="px-4 py-2 rounded-xl text-xs font-bold border transition ${acc.payer===u?'bg-jp-accent text-white border-jp-accent':'bg-gray-50 text-gray-400 border-transparent'}">${u}</button>`).join(''); }
    function setCurrency(c) { acc.cur=c; document.getElementById('cur-twd').className=c==='TWD'?'px-3 h-full rounded-lg bg-white shadow-sm text-jp-text font-bold':'px-3 h-full rounded-lg text-gray-400 font-bold'; document.getElementById('cur-thb').className=c==='THB'?'px-3 h-full rounded-lg bg-white shadow-sm text-jp-text font-bold':'px-3 h-full rounded-lg text-gray-400 font-bold'; }
    function updateFundDisplay() { document.getElementById('acc-fund-display').innerText = `‡∏ø ${state.fundBalance}`; document.getElementById('home-fund-display').innerText = `‡∏ø ${state.fundBalance}`; }
    function submitTx() { const amt=parseFloat(document.getElementById('amt-input').value); if(!amt) return alert("Ëº∏ÂÖ•ÈáëÈ°ç"); if(acc.payer==='ÂÖ¨Ë≤ªÂåÖ') state.fundBalance-=amt; state.transactions.unshift({id:Date.now(), date:new Date().toLocaleString(), amt, note:document.getElementById('note-input').value, payer:acc.payer, cat:acc.cat, cur:acc.cur}); saveData(); updateFundDisplay(); renderHistory(); document.getElementById('amt-input').value=''; alert("Â∑≤Ë®òÈåÑ"); }
    function renderHistory() { document.getElementById('tx-history').innerHTML = state.transactions.slice(0,10).map(t=>`<div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center border border-white"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-xs text-gray-400 font-bold">${t.payer[0]}</div><div><p class="text-sm font-bold text-jp-text">${t.note||t.cat}</p><p class="text-[10px] text-gray-400">${t.date.split(' ')[0]}</p></div></div><span class="font-bold text-jp-text">- ${t.amt}</span></div>`).join(''); }
    function editUsers() { const n=prompt("ÊàêÂì°ÂêçÂñÆ (,ÂàÜÈöî)", state.users.join(',')); if(n) { state.users=n.split(','); saveData(); renderPayers(); } }

    // Checklist Rendering
    function renderChecklist() { document.getElementById('checklist-container').innerHTML = state.checklist.map((c,i)=>`<div class="bg-white rounded-2xl p-5 shadow-card mb-4 border border-white"><h3 class="font-bold text-jp-text mb-3 flex justify-between">${c.title} <button onclick="state.checklist.splice(${i},1);saveData();renderChecklist()" class="text-gray-200 text-xs"><i class="fas fa-trash"></i></button></h3><div class="space-y-2">${c.items.map((m,j)=>`<label class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 transition"><input type="checkbox" ${m.checked?'checked':''} onchange="state.checklist[${i}].items[${j}].checked=this.checked;saveData();renderChecklist()" class="w-5 h-5 rounded-md accent-jp-green"><span class="text-sm ${m.checked?'line-through text-gray-300':'text-gray-600'}">${m.name}</span></label>`).join('')}</div><button onclick="const n=prompt('Êñ∞Â¢ûÈ†ÖÁõÆ');if(n){state.checklist[${i}].items.push({name:n,checked:false});saveData();renderChecklist()}" class="w-full mt-3 py-2 text-xs font-bold text-gray-400 bg-gray-50 rounded-xl hover:bg-gray-100">+ Add Item</button></div>`).join(''); 
        const total = state.checklist.reduce((acc, c) => acc + c.items.length, 0);
        const done = state.checklist.reduce((acc, c) => acc + c.items.filter(i=>i.checked).length, 0);
        document.getElementById('home-check-progress').innerText = `${total===0?0:Math.round((done/total)*100)}% Ready`;
    }
    function addChecklistCategory() { state.checklist.push({title:'New List', items:[]}); saveData(); renderChecklist(); }
    function addChecklistItem() { if(state.checklist.length>0) { const n=prompt("È†ÖÁõÆ"); if(n){state.checklist[0].items.push({name:n,checked:false});saveData();renderChecklist();} } }

</script>
</body>
</html>
